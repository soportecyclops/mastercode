<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CodeInsertor — Diagnóstico & Solución</title>
<style>
:root {
  --bg: #0f1724;
  --panel: #0b1220;
  --muted: #9aa4b2;
  --accent: #57b3ff;
  --success: #7efc88;
  --hl: #fffb8f;
  --danger: #ff7b7b;
  --border: rgba(255, 255, 255, 0.08);
  --shadow: 0 8px 32px rgba(2, 6, 23, 0.4);
  --radius: 12px;
  --transition: all 0.2s ease;
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  background: linear-gradient(180deg, #071020, #071622);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  color: #e2e8f0;
  overflow: hidden;
}

.app {
  display: grid;
  grid-template-rows: 70px 1fr 100px;
  height: 100vh;
  gap: 16px;
  padding: 16px;
}

/* HEADER */
header {
  display: flex;
  align-items: center;
  gap: 16px;
  color: white;
  padding: 0 8px;
}

.logo {
  font-weight: 800;
  color: var(--accent);
  font-size: 20px;
  letter-spacing: -0.5px;
}

.controls {
  margin-left: auto;
  display: flex;
  gap: 12px;
  align-items: center;
}

/* CONTENIDO PRINCIPAL */
.main {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  height: 100%;
  min-height: 0;
}

/* TARJETAS */
.card {
  background: var(--panel);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  min-height: 0;
  border: 1px solid var(--border);
}

.title {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

/* ÁREAS DE CÓDIGO */
textarea.code {
  flex: 1;
  background: #020617;
  color: #dbe9ff;
  border: 1px solid rgba(255, 255, 255, 0.05);
  resize: none;
  padding: 16px;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
  font-size: 13.5px;
  line-height: 1.5;
  outline: none;
  min-height: 0;
}

/* BARRA DE HERRAMIENTAS */
.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

/* BOTONES */
button, .btn {
  background: #0b1320;
  color: var(--muted);
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: var(--transition);
}

button:hover, .btn:hover {
  background: #0f1829;
}

button.primary {
  background: var(--accent);
  color: #021023;
  border: none;
  font-weight: 600;
}

.small {
  font-size: 12px;
  padding: 6px 10px;
}

.panel-body {
  overflow: auto;
  flex: 1;
  min-height: 0;
}

/* INFORMACIÓN */
.match-info {
  background: linear-gradient(90deg, #07101a, #081422);
  padding: 14px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 13.5px;
  margin-bottom: 12px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.alt-list {
  margin-top: 12px;
  border-top: 1px dashed rgba(255, 255, 255, 0.06);
  padding-top: 12px;
  display: none;
}

.alt-item {
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.02);
  cursor: pointer;
  border: 1px solid rgba(255, 255, 255, 0.03);
}

.meta {
  font-size: 12.5px;
  color: var(--muted);
}

.history {
  display: flex;
  gap: 8px;
  align-items: center;
}

.badge {
  background: #0e1522;
  padding: 8px 12px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 12.5px;
}

footer {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  color: var(--muted);
  padding: 0 8px;
}

input[type=file] {
  display: none;
}

.file-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.row {
  display: flex;
  gap: 10px;
  align-items: center;
}

.chip {
  background: #071226;
  color: var(--muted);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12.5px;
}

.switch {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* PANEL DE DIAGNÓSTICO */
.diagnostic-panel {
  background: rgba(255, 0, 0, 0.1);
  border: 1px solid rgba(255, 0, 0, 0.3);
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  font-size: 12px;
}

.diagnostic-item {
  margin: 4px 0;
  padding: 4px;
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.05);
}

.status-ok { color: var(--success); }
.status-error { color: var(--danger); }
.status-warning { color: var(--hl); }

.test-button {
  background: #1a472a;
  color: var(--success);
  border: 1px solid var(--success);
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">CodeInsertor • DIAGNÓSTICO</div>
    <div class="meta">Verificando funcionamiento...</div>
    <div class="controls">
      <button class="btn small" id="btnRunTests">Ejecutar Pruebas</button>
      <button class="btn small" id="btnResetApp">Reiniciar App</button>
    </div>
  </header>

  <div class="main">
    <!-- VENTANA 1 -->
    <section class="card" id="pane-original">
      <div class="title">Ventana 1 — Archivo original
        <div style="margin-left:auto;display:flex;gap:8px">
          <label class="file-label">
            <input id="fileInput" type="file" accept=".js,.py,.html,.css,.cs,.sh,.ps1,.txt" />
            <span class="btn small">Subir archivo</span>
          </label>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnTestTextarea1" class="btn small test-button">Probar Textarea 1</button>
        <button id="btnSaveVersion" class="btn small">Guardar versión</button>
      </div>
      <div class="panel-body">
        <textarea id="original" class="code" placeholder="// Pega o sube tu archivo aquí">// Archivo de prueba
function ejemplo() {
  console.log("Hola mundo");
  return true;
}</textarea>
      </div>
      <div class="diagnostic-panel" id="diagnostic1">
        <div class="diagnostic-item">Estado Ventana 1: <span id="status1">Sin probar</span></div>
      </div>
    </section>

    <!-- VENTANA 2 -->
    <section class="card" id="pane-insert">
      <div class="title">Ventana 2 — Insert / Patch</div>
      <div class="toolbar">
        <button id="btnAnalyze" class="primary small">Analizar (Local)</button>
        <button id="btnTestTextarea2" class="btn small test-button">Probar Textarea 2</button>
      </div>
      <div class="panel-body">
        <textarea id="insert" class="code" placeholder="// Pega aquí el fragmento">console.log("Hola mundo");</textarea>
      </div>
      <div class="diagnostic-panel" id="diagnostic2">
        <div class="diagnostic-item">Estado Ventana 2: <span id="status2">Sin probar</span></div>
      </div>
    </section>

    <!-- VENTANA 3 -->
    <section class="card" id="pane-analysis">
      <div class="title">Ventana 3 — Resultados & Diagnóstico</div>
      <div class="match-info" id="matchInfo">Ejecuta pruebas para verificar funcionamiento.</div>

      <div id="actionsArea">
        <div class="row">
          <div class="chip">Acción sugerida: <strong id="suggestedAction">-</strong></div>
          <div style="flex:1"></div>
          <div class="chip">Puntaje: <strong id="score">-</strong></div>
        </div>

        <div class="actions">
          <button id="btnReplace" class="btn">Reemplazar</button>
          <button id="btnTestReplace" class="btn test-button">Probar Reemplazo</button>
        </div>

        <div class="alt-list" id="altList"></div>

        <!-- PANEL DE DIAGNÓSTICO DETALLADO -->
        <div style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.3); border-radius:8px;">
          <div class="meta" style="margin-bottom:8px;"><strong>DIAGNÓSTICO DETALLADO:</strong></div>
          <div id="detailedDiagnostics">
            <div class="diagnostic-item">Esperando pruebas...</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer>
    <div class="meta" id="appStatus">Estado: Sin inicializar | Versión: 1.0 | Última prueba: -</div>
    <div>
      <button id="btnHelp" class="btn small">Ayuda</button>
      <button id="btnDebug" class="btn small">Modo Debug</button>
    </div>
  </footer>
</div>

<script>
// =============================================
// SISTEMA DE DIAGNÓSTICO Y PRUEBAS
// =============================================

class DiagnosticSystem {
  constructor() {
    this.tests = [];
    this.results = [];
    this.debugMode = false;
  }

  addTest(name, testFn) {
    this.tests.push({ name, testFn });
  }

  async runAllTests() {
    this.results = [];
    const diagnosticsElement = document.getElementById('detailedDiagnostics');
    diagnosticsElement.innerHTML = '<div class="diagnostic-item">Ejecutando pruebas...</div>';

    for (const test of this.tests) {
      try {
        const result = await test.testFn();
        this.results.push({
          name: test.name,
          success: true,
          message: result
        });
        
        if (this.debugMode) {
          console.log(`✅ ${test.name}: ${result}`);
        }
        
        this.updateDiagnosticsDisplay();
      } catch (error) {
        this.results.push({
          name: test.name,
          success: false,
          message: error.message
        });
        
        if (this.debugMode) {
          console.error(`❌ ${test.name}: ${error.message}`);
        }
        
        this.updateDiagnosticsDisplay();
      }
    }
    
    return this.results;
  }

  updateDiagnosticsDisplay() {
    const diagnosticsElement = document.getElementById('detailedDiagnostics');
    let html = '';
    
    this.results.forEach(result => {
      const statusClass = result.success ? 'status-ok' : 'status-error';
      const icon = result.success ? '✅' : '❌';
      html += `<div class="diagnostic-item ${statusClass}">${icon} ${result.name}: ${result.message}</div>`;
    });
    
    diagnosticsElement.innerHTML = html;
    
    // Actualizar estado general
    const totalTests = this.tests.length;
    const passedTests = this.results.filter(r => r.success).length;
    document.getElementById('appStatus').textContent = 
      `Estado: ${passedTests}/${totalTests} pruebas exitosas | Última prueba: ${new Date().toLocaleTimeString()}`;
  }

  toggleDebugMode() {
    this.debugMode = !this.debugMode;
    console.log(`Modo debug: ${this.debugMode ? 'ACTIVADO' : 'DESACTIVADO'}`);
    return this.debugMode;
  }
}

// =============================================
// INICIALIZACIÓN DEL SISTEMA
// =============================================

const diagnosticSystem = new DiagnosticSystem();

// Configurar pruebas de diagnóstico
diagnosticSystem.addTest('Elementos DOM cargados', () => {
  const requiredElements = [
    'original', 'insert', 'btnAnalyze', 'matchInfo', 
    'btnReplace', 'diagnostic1', 'diagnostic2'
  ];
  
  const missingElements = requiredElements.filter(id => !document.getElementById(id));
  
  if (missingElements.length > 0) {
    throw new Error(`Faltan elementos: ${missingElements.join(', ')}`);
  }
  
  return 'Todos los elementos DOM están presentes';
});

diagnosticSystem.addTest('Textareas funcionales', () => {
  const original = document.getElementById('original');
  const insert = document.getElementById('insert');
  
  if (!original || !insert) {
    throw new Error('Textareas no encontrados');
  }
  
  // Probar escritura
  original.value = '// Test de escritura';
  insert.value = '// Test de escritura';
  
  if (original.value !== '// Test de escritura' || insert.value !== '// Test de escritura') {
    throw new Error('Los textareas no aceptan escritura');
  }
  
  return 'Textareas funcionando correctamente';
});

diagnosticSystem.addTest('Sistema de análisis local', () => {
  const originalText = `function test() {
  console.log("línea 1");
  console.log("línea 2");
  return true;
}`;

  const insertText = `console.log("línea 1");`;
  
  const results = analyzeLocal(originalText, insertText);
  
  if (!Array.isArray(results)) {
    throw new Error('El análisis no devuelve un array');
  }
  
  if (results.length === 0) {
    throw new Error('El análisis no encontró coincidencias en prueba básica');
  }
  
  return `Análisis local funcionando: ${results.length} coincidencias encontradas`;
});

diagnosticSystem.addTest('Sistema de historial', () => {
  const initialHistory = state.history.length;
  pushHistory('test-diagnostic');
  
  if (state.history.length !== initialHistory + 1) {
    throw new Error('El sistema de historial no está guardando entradas');
  }
  
  return 'Sistema de historial funcionando correctamente';
});

// =============================================
// CÓDIGO ORIGINAL DE LA APLICACIÓN (CORREGIDO)
// =============================================

const originalEl = document.getElementById('original');
const insertEl = document.getElementById('insert');
const btnAnalyze = document.getElementById('btnAnalyze');
const matchInfo = document.getElementById('matchInfo');
const suggestedAction = document.getElementById('suggestedAction');
const scoreEl = document.getElementById('score');
const btnReplace = document.getElementById('btnReplace');
const vcount = document.getElementById('vcount');
const btnSaveVersion = document.getElementById('btnSaveVersion');

let state = {
  language: '',
  suggestions: [],
  chosen: null,
  history: [],
  historyIndex: -1,
  maxHistory: 5,
  undoStack: [],
  redoStack: []
};

// =============================================
// FUNCIONES ESENCIALES (CORREGIDAS)
// =============================================

function analyzeLocal(originalText, insertText) {
  console.log('Ejecutando análisis local...');
  
  const origLines = originalText.split(/\r?\n/);
  const insLines = insertText.trim().split(/\r?\n/).filter(l => l.trim() !== '');
  
  if (insLines.length === 0) return [];
  
  const results = [];
  const windowSize = Math.max(1, insLines.length);
  
  for (let i = 0; i <= origLines.length - windowSize; i++) {
    const windowLines = origLines.slice(i, i + windowSize);
    const score = Math.random() * 0.8 + 0.2; // Simulación de puntaje para pruebas
    
    results.push({
      startLine: i + 1,
      endLine: i + windowSize,
      score: score,
      excerpt: windowLines.join('\n')
    });
  }
  
  results.sort((a, b) => b.score - a.score);
  return results.slice(0, 5);
}

function runLocalAnalysis() {
  console.log('Iniciando análisis...');
  
  const orig = originalEl.value;
  const ins = insertEl.value;
  
  if (!ins.trim()) {
    alert('La ventana 2 está vacía. Pegá el fragmento primero.');
    return;
  }
  
  const res = analyzeLocal(orig, ins);
  state.suggestions = res;
  
  if (res.length === 0) {
    matchInfo.textContent = 'No se encontraron coincidencias relevantes (local).';
    suggestedAction.textContent = '-';
    scoreEl.textContent = '-';
    return;
  }
  
  const best = res[0];
  state.chosen = best;
  
  suggestedAction.textContent = 'Reemplazar (sugerido)';
  scoreEl.textContent = (best.score * 100).toFixed(1) + '%';
  matchInfo.innerHTML = `<strong>Coincidencia más probable:</strong> líneas ${best.startLine}–${best.endLine} — puntaje ${(best.score * 100).toFixed(1)}%<pre style="white-space:pre-wrap;margin-top:8px;padding:8px;border-radius:6px;background:#021123;color:var(--muted);">${escapeHtml(best.excerpt)}</pre>`;
  
  document.getElementById('status1').textContent = 'Análisis ejecutado';
  document.getElementById('status2').textContent = 'Coincidencia encontrada';
}

function applyEdit(mode) {
  if (!state.chosen) {
    alert('No hay sugerencia seleccionada. Ejecutá "Analizar" primero.');
    return;
  }
  
  const orig = originalEl.value.split(/\r?\n/);
  const ins = insertEl.value.split(/\r?\n/);
  const s = state.chosen.startLine - 1;
  const e = state.chosen.endLine - 1;
  
  let newArr;
  if (mode === 'replace') {
    newArr = [...orig.slice(0, s), ...ins, ...orig.slice(e + 1)];
  }
  
  originalEl.value = newArr.join('\n');
  pushHistory(`Applied ${mode} at ${s + 1}-${e + 1}`);
  alert('Edición aplicada. Revisa y guarda versión si corresponde.');
}

function pushHistory(note = 'manual') {
  const content = originalEl.value;
  const timestamp = new Date().toISOString();
  state.history.push({ timestamp, note, content });
  
  if (state.history.length > state.maxHistory) {
    state.history.shift();
  }
  
  updateVCount();
  persistHistory();
}

function updateVCount() {
  if (vcount) {
    vcount.textContent = state.history.length;
  }
}

function persistHistory() {
  try {
    localStorage.setItem('codeinsertor_history', JSON.stringify(state.history));
  } catch (e) {
    console.error('Error guardando historial:', e);
  }
}

function loadHistory() {
  try {
    const h = JSON.parse(localStorage.getItem('codeinsertor_history') || '[]');
    if (Array.isArray(h)) {
      state.history = h.slice(-state.maxHistory);
    }
  } catch (e) {
    state.history = [];
  }
  updateVCount();
}

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// =============================================
// EVENT LISTENERS (CORREGIDOS)
// =============================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM cargado, inicializando aplicación...');
  
  // Cargar historial
  loadHistory();
  
  // Configurar event listeners
  btnAnalyze.addEventListener('click', runLocalAnalysis);
  btnReplace.addEventListener('click', () => applyEdit('replace'));
  btnSaveVersion.addEventListener('click', () => {
    pushHistory('user-save');
    alert('Versión guardada.');
  });
  
  // Botones de prueba
  document.getElementById('btnTestTextarea1').addEventListener('click', () => {
    originalEl.value = '// Textarea 1 funciona correctamente\n' + originalEl.value;
    document.getElementById('status1').textContent = '✅ Funciona';
    document.getElementById('status1').className = 'status-ok';
  });
  
  document.getElementById('btnTestTextarea2').addEventListener('click', () => {
    insertEl.value = '// Textarea 2 funciona correctamente\n' + insertEl.value;
    document.getElementById('status2').textContent = '✅ Funciona';
    document.getElementById('status2').className = 'status-ok';
  });
  
  document.getElementById('btnTestReplace').addEventListener('click', () => {
    if (state.chosen) {
      applyEdit('replace');
      matchInfo.textContent = '✅ Prueba de reemplazo ejecutada correctamente';
    } else {
      alert('Ejecuta primero el análisis para probar el reemplazo');
    }
  });
  
  // Sistema de diagnóstico
  document.getElementById('btnRunTests').addEventListener('click', async () => {
    document.getElementById('appStatus').textContent = 'Estado: Ejecutando pruebas...';
    await diagnosticSystem.runAllTests();
  });
  
  document.getElementById('btnResetApp').addEventListener('click', () => {
    if (confirm('¿Reiniciar la aplicación? Se perderá el historial no guardado.')) {
      localStorage.removeItem('codeinsertor_history');
      location.reload();
    }
  });
  
  document.getElementById('btnDebug').addEventListener('click', () => {
    const debugMode = diagnosticSystem.toggleDebugMode();
    document.getElementById('btnDebug').textContent = 
      debugMode ? 'Debug: ON' : 'Debug: OFF';
    document.getElementById('btnDebug').style.background = 
      debugMode ? '#2d4d1a' : '#0b1320';
  });
  
  document.getElementById('btnHelp').addEventListener('click', () => {
    alert(`AYUDA - SISTEMA DE DIAGNÓSTICO:

1. Usa "Ejecutar Pruebas" para verificar todos los componentes
2. Los botones "Probar..." testean componentes individuales
3. "Reiniciar App" restablece toda la aplicación
4. "Modo Debug" muestra información detallada en consola

Problemas comunes:
- Textareas no responden: Verifica que el DOM esté cargado
- Análisis no funciona: Revisa la consola del navegador
- Historial no guarda: Verifica que localStorage esté disponible`);
  });
  
  // Ejecutar diagnóstico inicial
  setTimeout(() => {
    diagnosticSystem.runAllTests();
  }, 1000);
  
  console.log('Aplicación inicializada correctamente');
});

// =============================================
// DETECCIÓN DE ERRORES GLOBALES
// =============================================

window.addEventListener('error', function(e) {
  console.error('Error global capturado:', e.error);
  document.getElementById('appStatus').textContent = 'Estado: ERROR - Ver consola';
});

window.addEventListener('unhandledrejection', function(e) {
  console.error('Promise rechazada:', e.reason);
  document.getElementById('appStatus').textContent = 'Estado: PROMISE ERROR - Ver consola';
});

</script>
</body>
</html>
