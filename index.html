<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CodeInsertor ‚Äî Algoritmo Mejorado</title>
    <style>
        /* Mantengo los mismos estilos pero mejoro el algoritmo */
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #57b3ff;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--panel);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .pane {
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            height: 70vh;
        }

        .pane-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .pane-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .pane-content {
            flex: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        textarea {
            flex: 1;
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(87, 179, 255, 0.1);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #3d9ee8;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .floating-controls {
            position: sticky;
            top: 0;
            background: var(--panel);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .analysis-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(87, 179, 255, 0.1);
            border-radius: var(--radius);
            border-left: 4px solid var(--accent);
        }

        .match-percentage {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .analysis-stats {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
            overflow-y: auto;
        }

        .suggestion-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }

        .suggestion-item.selected {
            background: rgba(87, 179, 255, 0.1);
            border-color: var(--accent);
        }

        .suggestion-score {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .suggestion-excerpt {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 120px;
            overflow: hidden;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        footer {
            background: var(--panel);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .debug-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="header-content">
                <div class="logo">
                    <h1>CodeInsertor</h1>
                    <span class="version">v1.4 - Algoritmo Mejorado</span>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- Ventana 1: C√≥digo Original -->
            <section class="pane" id="pane-original">
                <div class="pane-header">
                    <h2>C√≥digo Original</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearOriginal()">Limpiar</button>
                        <button class="btn btn-secondary" onclick="loadExample('original')">Ejemplo HTML</button>
                    </div>
                </div>
                <div class="pane-content">
                    <textarea id="originalEl" placeholder="Pega tu c√≥digo original aqu√≠..."></textarea>
                </div>
            </section>

            <!-- Ventana 2: Fragmento a Insertar -->
            <section class="pane" id="pane-insert">
                <div class="pane-header">
                    <h2>Fragmento a Insertar</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearInsert()">Limpiar</button>
                        <button class="btn btn-secondary" onclick="loadExample('insert')">Ejemplo HTML</button>
                    </div>
                </div>
                <div class="pane-content">
                    <textarea id="insertEl" placeholder="Pega el fragmento que quieres insertar..."></textarea>
                    <button class="btn" id="analyzeBtn" onclick="runLocalAnalysis()">
                        Analizar Coincidencias
                    </button>
                </div>
            </section>

            <!-- Ventana 3: An√°lisis y Resultados -->
            <section class="pane" id="pane-analysis">
                <div class="pane-header">
                    <h2>An√°lisis y Resultados</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="showDebugInfo()">Info Debug</button>
                    </div>
                </div>
                <div class="pane-content">
                    <div class="floating-controls">
                        <div class="analysis-info">
                            <div class="match-percentage" id="matchPercentage">
                                Coincidencia: 0%
                            </div>
                            <div class="analysis-stats" id="analysisStats">
                                Sin an√°lisis
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="applyEdit('replace')" id="replaceBtn" disabled>Reemplazar</button>
                            <button class="btn" onclick="applyEdit('above')" id="aboveBtn" disabled>Insertar Arriba</button>
                            <button class="btn" onclick="applyEdit('below')" id="belowBtn" disabled>Insertar Debajo</button>
                        </div>
                    </div>

                    <div id="resultsContainer">
                        <p class="placeholder-text">Los resultados del an√°lisis aparecer√°n aqu√≠...</p>
                        <div class="suggestion-list" id="suggestionList" style="display: none;"></div>
                    </div>

                    <div id="debugInfo" class="debug-info" style="display: none;">
                        <!-- Informaci√≥n de debug aparecer√° aqu√≠ -->
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-info">
                    <p>CodeInsertor v1.4 - Algoritmo de comparaci√≥n mejorado</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        const state = {
            suggestions: [],
            chosen: null,
            originalContent: '',
            debugInfo: ''
        };

        // Elementos DOM
        const originalEl = document.getElementById('originalEl');
        const insertEl = document.getElementById('insertEl');
        const suggestionList = document.getElementById('suggestionList');
        const resultsContainer = document.getElementById('resultsContainer');
        const matchPercentage = document.getElementById('matchPercentage');
        const analysisStats = document.getElementById('analysisStats');
        const replaceBtn = document.getElementById('replaceBtn');
        const aboveBtn = document.getElementById('aboveBtn');
        const belowBtn = document.getElementById('belowBtn');
        const debugInfo = document.getElementById('debugInfo');

        // Sistema de notificaciones
        class NotificationSystem {
            static show(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <span class="icon">${this.getIcon(type)}</span>
                    <span class="message">${message}</span>
                    <button class="close" onclick="this.parentElement.remove()">√ó</button>
                `;
                
                document.body.appendChild(notification);
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            static getIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || icons.info;
            }
        }

        // ALGORITMO MEJORADO DE COMPARACI√ìN
        class ImprovedAnalyzer {
            static analyzeLocal(originalText, insertText) {
                if (!insertText.trim()) {
                    throw new Error('El fragmento a insertar est√° vac√≠o');
                }

                console.log("=== INICIANDO AN√ÅLISIS MEJORADO ===");
                console.log("Longitud original:", originalText.length);
                console.log("Longitud insert:", insertText.length);

                // M√∫ltiples estrategias de comparaci√≥n
                const strategies = [
                    this.analyzeByLines(originalText, insertText),
                    this.analyzeByBlocks(originalText, insertText),
                    this.analyzeByStructure(originalText, insertText),
                    this.analyzeByKeywords(originalText, insertText)
                ];

                // Combinar resultados de todas las estrategias
                let allResults = [];
                strategies.forEach((results, index) => {
                    console.log(`Estrategia ${index + 1} encontr√≥:`, results.length, "resultados");
                    allResults = allResults.concat(results);
                });

                // Agrupar y ordenar resultados
                const finalResults = this.mergeAndSortResults(allResults, originalText);
                
                console.log("=== RESULTADOS FINALES ===");
                console.log("Total de coincidencias encontradas:", finalResults.length);
                finalResults.forEach((result, idx) => {
                    console.log(`Coincidencia ${idx + 1}: ${Math.round(result.score * 100)}% - L√≠neas ${result.startLine}-${result.endLine}`);
                });

                return finalResults.slice(0, 5); // Top 5 resultados
            }

            // Estrategia 1: Comparaci√≥n por l√≠neas
            static analyzeByLines(originalText, insertText) {
                const results = [];
                const originalLines = originalText.split('\n');
                const insertLines = insertText.split('\n').filter(line => line.trim().length > 0);
                
                if (insertLines.length === 0) return results;

                // Buscar secuencias de l√≠neas similares
                for (let i = 0; i <= originalLines.length - insertLines.length; i++) {
                    let matchCount = 0;
                    let totalScore = 0;

                    for (let j = 0; j < insertLines.length && (i + j) < originalLines.length; j++) {
                        const similarity = this.calculateLineSimilarity(originalLines[i + j], insertLines[j]);
                        if (similarity > 0.6) { // Umbral m√°s bajo para l√≠neas individuales
                            matchCount++;
                            totalScore += similarity;
                        }
                    }

                    if (matchCount >= Math.max(1, insertLines.length * 0.3)) { // Al menos 30% de coincidencia
                        const avgScore = totalScore / matchCount;
                        results.push({
                            startLine: i + 1,
                            endLine: i + insertLines.length,
                            score: avgScore * (matchCount / insertLines.length),
                            excerpt: originalLines.slice(i, i + 5).join('\n'), // Primeras 5 l√≠neas
                            strategy: 'lines'
                        });
                    }
                }

                return results;
            }

            // Estrategia 2: Comparaci√≥n por bloques estructurales
            static analyzeByBlocks(originalText, insertText) {
                const results = [];
                
                // Extraer bloques estructurales (funciones, clases, elementos HTML)
                const originalBlocks = this.extractStructuralBlocks(originalText);
                const insertBlocks = this.extractStructuralBlocks(insertText);

                console.log("Bloques originales:", originalBlocks.length);
                console.log("Bloques insert:", insertBlocks.length);

                insertBlocks.forEach(insertBlock => {
                    originalBlocks.forEach(originalBlock => {
                        const similarity = this.calculateBlockSimilarity(originalBlock.content, insertBlock.content);
                        if (similarity > 0.4) {
                            results.push({
                                startLine: originalBlock.startLine,
                                endLine: originalBlock.endLine,
                                score: similarity,
                                excerpt: originalBlock.content.substring(0, 200) + '...',
                                strategy: 'blocks'
                            });
                        }
                    });
                });

                return results;
            }

            // Estrategia 3: Comparaci√≥n por estructura general
            static analyzeByStructure(originalText, insertText) {
                const results = [];
                
                // Normalizar textos para comparaci√≥n estructural
                const normalizedOriginal = this.normalizeForStructuralComparison(originalText);
                const normalizedInsert = this.normalizeForStructuralComparison(insertText);

                // Buscar subcadenas largas comunes
                const commonSubstrings = this.findLongCommonSubstrings(normalizedOriginal, normalizedInsert);
                
                commonSubstrings.forEach(substring => {
                    if (substring.length > 20) { // Solo subcadenas significativas
                        const positions = this.findAllOccurrences(originalText, substring);
                        positions.forEach(pos => {
                            const lines = this.getLineRange(originalText, pos, pos + substring.length);
                            results.push({
                                startLine: lines.start,
                                endLine: lines.end,
                                score: Math.min(1.0, substring.length / 100), // Score basado en longitud
                                excerpt: substring.substring(0, 150) + '...',
                                strategy: 'structure'
                            });
                        });
                    }
                });

                return results;
            }

            // Estrategia 4: Comparaci√≥n por palabras clave importantes
            static analyzeByKeywords(originalText, insertText) {
                const results = [];
                
                const originalKeywords = this.extractKeywords(originalText);
                const insertKeywords = this.extractKeywords(insertText);
                
                const commonKeywords = originalKeywords.filter(kw => 
                    insertKeywords.some(ikw => this.calculateSimilarity(kw, ikw) > 0.8)
                );

                if (commonKeywords.length > 0) {
                    // Buscar √°reas con alta densidad de palabras clave comunes
                    const lines = originalText.split('\n');
                    for (let i = 0; i < lines.length; i++) {
                        let keywordCount = 0;
                        commonKeywords.forEach(keyword => {
                            if (lines[i].toLowerCase().includes(keyword.toLowerCase())) {
                                keywordCount++;
                            }
                        });

                        if (keywordCount >= 2) { // Al menos 2 palabras clave en la misma l√≠nea
                            results.push({
                                startLine: i + 1,
                                endLine: i + 1,
                                score: Math.min(0.7, keywordCount * 0.2),
                                excerpt: lines[i],
                                strategy: 'keywords'
                            });
                        }
                    }
                }

                return results;
            }

            // M√©todos auxiliares mejorados
            static calculateLineSimilarity(line1, line2) {
                if (!line1 || !line2) return 0;
                
                // Normalizar l√≠neas
                const norm1 = this.normalizeLine(line1);
                const norm2 = this.normalizeLine(line2);
                
                if (norm1 === norm2) return 1.0;
                
                // Similitud por tokens
                const tokens1 = new Set(norm1.split(/\s+/).filter(t => t.length > 2));
                const tokens2 = new Set(norm2.split(/\s+/).filter(t => t.length > 2));
                
                const intersection = new Set([...tokens1].filter(x => tokens2.has(x)));
                const union = new Set([...tokens1, ...tokens2]);
                
                return union.size > 0 ? intersection.size / union.size : 0;
            }

            static normalizeLine(line) {
                return line
                    .trim()
                    .replace(/\s+/g, ' ')
                    .replace(/[^\w\s<>\/="':-]/g, '') // Mantener caracteres importantes para c√≥digo
                    .toLowerCase();
            }

            static extractStructuralBlocks(text) {
                const blocks = [];
                const lines = text.split('\n');
                let currentBlock = null;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Detectar inicio de bloques
                    if (line.match(/<(div|section|script|style|function|class)\b/) || 
                        line.match(/(function|class)\s+\w/) ||
                        line.includes('{') && !line.includes('}')) {
                        
                        if (currentBlock) {
                            blocks.push(currentBlock);
                        }
                        currentBlock = {
                            startLine: i + 1,
                            content: line + '\n',
                            type: this.detectBlockType(line)
                        };
                    } 
                    // Continuar bloque actual
                    else if (currentBlock) {
                        currentBlock.content += line + '\n';
                        
                        // Detectar fin de bloque
                        if (line.includes('</') || line.includes('}') || 
                            (line === '' && i > currentBlock.startLine + 10)) {
                            currentBlock.endLine = i + 1;
                            blocks.push(currentBlock);
                            currentBlock = null;
                        }
                    }
                }

                if (currentBlock) {
                    currentBlock.endLine = lines.length;
                    blocks.push(currentBlock);
                }

                return blocks;
            }

            static detectBlockType(line) {
                if (line.includes('<div')) return 'html';
                if (line.includes('<script')) return 'script';
                if (line.includes('<style')) return 'style';
                if (line.includes('function')) return 'function';
                if (line.includes('class')) return 'class';
                return 'unknown';
            }

            static calculateBlockSimilarity(block1, block2) {
                const lines1 = block1.split('\n').filter(l => l.trim());
                const lines2 = block2.split('\n').filter(l => l.trim());
                
                if (lines1.length === 0 || lines2.length === 0) return 0;
                
                let totalSimilarity = 0;
                let comparisons = 0;
                
                // Comparar l√≠neas correspondientes
                const minLines = Math.min(lines1.length, lines2.length);
                for (let i = 0; i < minLines; i++) {
                    totalSimilarity += this.calculateLineSimilarity(lines1[i], lines2[i]);
                    comparisons++;
                }
                
                return comparisons > 0 ? totalSimilarity / comparisons : 0;
            }

            static normalizeForStructuralComparison(text) {
                return text
                    .toLowerCase()
                    .replace(/\s+/g, ' ')
                    .replace(/<!--.*?-->/g, '') // Remover comentarios
                    .replace(/\/\*.*?\*\//g, '')
                    .replace(/\/\/.*$/gm, '')
                    .trim();
            }

            static findLongCommonSubstrings(str1, str2) {
                const substrings = [];
                const maxLength = 100; // Longitud m√°xima para evitar sobrecarga
                
                for (let len = maxLength; len >= 10; len--) {
                    for (let i = 0; i <= str1.length - len; i++) {
                        const substring = str1.substring(i, i + len);
                        if (str2.includes(substring)) {
                            substrings.push(substring);
                            // Saltar adelante para evitar solapamientos
                            i += len - 1;
                        }
                    }
                    if (substrings.length > 0) break; // Encontrar las m√°s largas primero
                }
                
                return substrings;
            }

            static findAllOccurrences(text, substring) {
                const positions = [];
                let pos = text.indexOf(substring);
                while (pos !== -1) {
                    positions.push(pos);
                    pos = text.indexOf(substring, pos + 1);
                }
                return positions;
            }

            static getLineRange(text, startPos, endPos) {
                const lines = text.split('\n');
                let currentPos = 0;
                let startLine = 1;
                let endLine = 1;
                
                for (let i = 0; i < lines.length; i++) {
                    const lineLength = lines[i].length + 1; // +1 por el \n
                    if (currentPos <= startPos && startPos < currentPos + lineLength) {
                        startLine = i + 1;
                    }
                    if (currentPos <= endPos && endPos < currentPos + lineLength) {
                        endLine = i + 1;
                        break;
                    }
                    currentPos += lineLength;
                }
                
                return { start: startLine, end: endLine };
            }

            static extractKeywords(text) {
                // Palabras clave comunes en c√≥digo
                const commonKeywords = ['function', 'class', 'var', 'let', 'const', 'return', 'if', 'else', 'for', 'while'];
                const words = text.toLowerCase().match(/\b\w+\b/g) || [];
                
                return words.filter(word => 
                    word.length > 3 && 
                    !commonKeywords.includes(word) &&
                    !word.match(/^\d+$/)
                ).slice(0, 20); // Limitar a 20 palabras clave
            }

            static calculateSimilarity(str1, str2) {
                const set1 = new Set(str1.toLowerCase());
                const set2 = new Set(str2.toLowerCase());
                const intersection = new Set([...set1].filter(x => set2.has(x)));
                const union = new Set([...set1, ...set2]);
                return union.size > 0 ? intersection.size / union.size : 0;
            }

            static mergeAndSortResults(results, originalText) {
                // Agrupar resultados similares
                const merged = [];
                const usedPositions = new Set();
                
                results.forEach(result => {
                    const key = `${result.startLine}-${result.endLine}`;
                    if (!usedPositions.has(key)) {
                        usedPositions.add(key);
                        
                        // Mejorar el score basado en la estrategia
                        let enhancedScore = result.score;
                        if (result.strategy === 'structure') enhancedScore *= 1.2;
                        if (result.strategy === 'blocks') enhancedScore *= 1.1;
                        
                        merged.push({
                            ...result,
                            score: Math.min(1.0, enhancedScore)
                        });
                    }
                });
                
                // Ordenar por score descendente
                return merged.sort((a, b) => b.score - a.score);
            }
        }

        // Funciones principales
        function runLocalAnalysis() {
            try {
                const originalText = originalEl.value;
                const insertText = insertEl.value;

                if (!originalText.trim() || !insertText.trim()) {
                    throw new Error('Ambas ventanas deben contener c√≥digo');
                }

                console.clear();
                console.log("=== EJECUTANDO AN√ÅLISIS MEJORADO ===");
                
                const results = ImprovedAnalyzer.analyzeLocal(originalText, insertText);
                state.suggestions = results;
                state.originalContent = originalText;

                displayResults(results);
                updateAnalysisInfo(results);

                NotificationSystem.show(`Encontradas ${results.length} coincidencias`, 'success');

            } catch (error) {
                NotificationSystem.show(`Error: ${error.message}`, 'error');
                console.error('Error en an√°lisis:', error);
            }
        }

        function displayResults(results) {
            const placeholder = resultsContainer.querySelector('.placeholder-text');
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            if (results.length === 0) {
                suggestionList.innerHTML = '<p class="placeholder-text">No se encontraron coincidencias significativas</p>';
                suggestionList.style.display = 'block';
                return;
            }

            suggestionList.innerHTML = results.map((result, index) => `
                <div class="suggestion-item ${index === 0 ? 'selected' : ''}" 
                     onclick="selectSuggestion(${index})">
                    <span class="suggestion-score">${Math.round(result.score * 100)}% coincidencia</span>
                    <small style="color: var(--text-secondary);">Estrategia: ${result.strategy}</small>
                    <div class="suggestion-excerpt">L√≠neas ${result.startLine}-${result.endLine}:\n${result.excerpt}</div>
                </div>
            `).join('');

            suggestionList.style.display = 'block';
            state.chosen = results[0];
            
            // Habilitar botones de acci√≥n
            replaceBtn.disabled = false;
            aboveBtn.disabled = false;
            belowBtn.disabled = false;
        }

        function updateAnalysisInfo(results) {
            if (results.length === 0) {
                matchPercentage.textContent = 'Coincidencia: 0%';
                analysisStats.textContent = 'Sin coincidencias';
                return;
            }

            const bestMatch = results[0];
            const percentage = Math.round(bestMatch.score * 100);
            
            matchPercentage.textContent = `Coincidencia: ${percentage}%`;
            analysisStats.textContent = `${results.length} sugerencias ¬∑ L√≠neas ${bestMatch.startLine}-${bestMatch.endLine}`;
        }

        function selectSuggestion(index) {
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.classList.remove('selected');
            });

            document.querySelectorAll('.suggestion-item')[index].classList.add('selected');
            state.chosen = state.suggestions[index];
        }

        function applyEdit(mode) {
            if (!state.chosen) {
                NotificationSystem.show('Selecciona una sugerencia primero', 'warning');
                return;
            }

            const modifiedCode = applyCodeChanges(mode);
            NotificationSystem.show('Cambios aplicados. Revisa el resultado.', 'success');
            originalEl.value = modifiedCode;
        }

        function applyCodeChanges(mode) {
            const lines = originalEl.value.split('\n');
            const insertContent = insertEl.value;
            const startIndex = state.chosen.startLine - 1;
            
            let modifiedLines;

            switch (mode) {
                case 'replace':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(state.chosen.endLine)
                    ];
                    break;
                case 'above':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(startIndex)
                    ];
                    break;
                case 'below':
                    modifiedLines = [
                        ...lines.slice(0, state.chosen.endLine),
                        insertContent,
                        ...lines.slice(state.chosen.endLine)
                    ];
                    break;
                default:
                    modifiedLines = lines;
            }

            return modifiedLines.join('\n');
        }

        function showDebugInfo() {
            const info = `
                === INFORMACI√ìN DE DEBUG ===
                Longitud original: ${originalEl.value.length}
                Longitud insert: ${insertEl.value.length}
                Coincidencias encontradas: ${state.suggestions.length}
                √öltima estrategia: ${state.chosen?.strategy || 'N/A'}
                
                Primeras 200 chars original:
                ${originalEl.value.substring(0, 200)}
                
                Primeras 200 chars insert:
                ${insertEl.value.substring(0, 200)}
            `;
            
            debugInfo.textContent = info;
            debugInfo.style.display = 'block';
        }

        // Funciones de utilidad
        function clearOriginal() {
            originalEl.value = '';
            NotificationSystem.show('Ventana original limpiada', 'info');
        }

        function clearInsert() {
            insertEl.value = '';
            NotificationSystem.show('Ventana de inserci√≥n limpiada', 'info');
        }

        function loadExample(type) {
            const examples = {
                original: `<!DOCTYPE html>
<html>
<head>
    <title>Ejemplo Original</title>
    <style>
        body { margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mi Aplicaci√≥n</h1>
        <p>Este es un ejemplo de c√≥digo HTML.</p>
    </div>
    <script>
        function init() {
            console.log("Aplicaci√≥n iniciada");
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>`,

                insert: `<!DOCTYPE html>
<html>
<head>
    <title>Ejemplo Mejorado</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mi Aplicaci√≥n Mejorada</h1>
        <p>Este es el c√≥digo HTML mejorado con nuevos estilos.</p>
    </div>
    <script>
        function enhancedInit() {
            console.log("Aplicaci√≥n mejorada iniciada");
            // Nuevas funcionalidades aqu√≠
        }
        document.addEventListener('DOMContentLoaded', enhancedInit);
    </script>
</body>
</html>`
            };

            if (type === 'original') {
                originalEl.value = examples.original;
            } else {
                insertEl.value = examples.insert;
            }

            NotificationSystem.show('Ejemplo cargado - Ahora prueba el an√°lisis!', 'success');
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            NotificationSystem.show('CodeInsertor v1.4 - Algoritmo mejorado cargado!', 'success');
        });
    </script>
</body>
</html>
                        const changeImpact = this.analyzeChangeImpact(excerpt, tokensInsert.join(' '));
                        
                        results.push({
                            startLine,
                            endLine,
                            score: similarity,
                            excerpt: excerpt,
                            changeImpact: changeImpact,
                            isRisky: changeImpact.level === 'high' || changeImpact.warnings.length > 0
                        });
                    }
                }

                return results.sort((a, b) => b.score - a.score).slice(0, 5);
            }

            static analyzeChangeImpact(originalExcerpt, insertText) {
                const impact = CodeValidator.calculateChangeImpact(originalExcerpt, insertText);
                const warnings = [];
                
                // An√°lisis de riesgo adicional
                if (impact.level === 'high') {
                    warnings.push('Cambio muy extenso detectado');
                }
                
                if (originalExcerpt.length < insertText.length * 0.1) {
                    warnings.push('Posible reemplazo completo de secci√≥n');
                }

                return {
                    level: impact.level,
                    warnings: warnings,
                    changes: impact.changes
                };
            }

            static jaccardSimilarity(setA, setB) {
                const intersection = new Set([...setA].filter(x => setB.has(x)));
                const union = new Set([...setA, ...setB]);
                return intersection.size / union.size;
            }

            static findLineNumber(text, tokenIndex) {
                const lines = text.split('\n');
                let currentLength = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const lineTokens = this.tokenize(lines[i]);
                    if (tokenIndex < lineTokens.length) {
                        return i + 1;
                    }
                    tokenIndex -= lineTokens.length;
                }
                
                return lines.length;
            }

            static getExcerpt(text, startLine, endLine) {
                const lines = text.split('\n');
                return lines.slice(Math.max(0, startLine - 2), endLine + 1).join('\n');
            }
        }

        // Funciones principales mejoradas
        function runLocalAnalysis() {
            setStatus('analyzing', 'Analizando c√≥digo...');

            try {
                // Validar que tenemos contenido
                if (!originalEl.value.trim()) {
                    throw new Error('El c√≥digo original est√° vac√≠o');
                }

                if (!insertEl.value.trim()) {
                    throw new Error('El fragmento a insertar est√° vac√≠o');
                }

                const results = LocalAnalyzer.analyzeLocal(originalEl.value, insertEl.value);
                state.suggestions = results;
                state.originalContent = originalEl.value;

                // Mostrar advertencia si hay m√∫ltiples secciones
                if (results.length > 1) {
                    NotificationSystem.show(
                        `‚ö†Ô∏è Se detectaron ${results.length} secciones coincidentes. ` +
                        `Solo se reemplazar√° UNA secci√≥n a la vez. ` +
                        `Selecciona cuidadosamente la secci√≥n correcta.`,
                        'warning',
                        6000
                    );
                }

                displayResults(results);
                updateAnalysisInfo(results);
                setStatus('success', 'An√°lisis completado');

                NotificationSystem.show(`Encontradas ${results.length} coincidencias`, 'success');
            } catch (error) {
                setStatus('error', 'Error en an√°lisis');
                NotificationSystem.show(`Error: ${error.message}`, 'error');
                console.error('Error en an√°lisis:', error);
            }
        }

        function displayResults(results) {
            const placeholder = resultsContainer.querySelector('.placeholder-text');
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            if (results.length === 0) {
                suggestionList.innerHTML = '<p class="placeholder-text">No se encontraron coincidencias significativas</p>';
                suggestionList.style.display = 'block';
                stickyActions.style.display = 'none';
                return;
            }

            suggestionList.innerHTML = results.map((result, index) => `
                <div class="suggestion-item ${result.isRisky ? 'warning' : ''} ${index === 0 ? 'selected' : ''}" 
                     onclick="selectSuggestion(${index})">
                    <span class="suggestion-score">${Math.round(result.score * 100)}% coincidencia</span>
                    ${result.isRisky ? '<span class="suggestion-warning">‚ö†Ô∏è RIESGO</span>' : ''}
                    <div class="suggestion-excerpt">L√≠neas ${result.startLine}-${result.endLine}:\n${result.excerpt}</div>
                    ${result.changeImpact.warnings.length > 0 ? 
                        `<div class="file-size-warning">${result.changeImpact.warnings[0]}</div>` : ''}
                </div>
            `).join('');

            suggestionList.style.display = 'block';
            stickyActions.style.display = 'block';
            state.chosen = results[0];
            
            // Habilitar botones de acci√≥n
            replaceBtn.disabled = false;
            aboveBtn.disabled = false;
            belowBtn.disabled = false;
        }

        function updateAnalysisInfo(results) {
            if (results.length === 0) {
                matchPercentage.textContent = 'Coincidencia: 0%';
                analysisStats.textContent = 'Sin coincidencias';
                state.currentMatchPercentage = 0;
                return;
            }

            const bestMatch = results[0];
            const percentage = Math.round(bestMatch.score * 100);
            state.currentMatchPercentage = percentage;
            
            matchPercentage.textContent = `Coincidencia: ${percentage}%`;
            analysisStats.textContent = `${results.length} sugerencias ¬∑ ${bestMatch.isRisky ? '‚ö†Ô∏è ' : ''}L√≠neas ${bestMatch.startLine}-${bestMatch.endLine}`;
        }

        function selectSuggestion(index) {
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.classList.remove('selected');
            });

            document.querySelectorAll('.suggestion-item')[index].classList.add('selected');
            state.chosen = state.suggestions[index];
            
            // Mostrar advertencia si la selecci√≥n es riesgosa
            if (state.chosen.isRisky) {
                NotificationSystem.show(
                    '‚ö†Ô∏è Esta selecci√≥n tiene indicadores de riesgo. ' +
                    'Revisa cuidadosamente antes de aplicar cambios.',
                    'warning',
                    5000
                );
            }
            
            updateAnalysisInfo(state.suggestions);
        }

        function applyEdit(mode) {
            if (!state.chosen) {
                NotificationSystem.show('Por favor selecciona una sugerencia primero', 'warning');
                return;
            }

            // Validaci√≥n final antes de aplicar cambios
            const validationWarnings = CodeValidator.validateSyntax(insertEl.value);
            const changeImpact = CodeValidator.calculateChangeImpact(
                state.chosen.excerpt, 
                insertEl.value
            );

            // Mostrar advertencias de validaci√≥n
            if (validationWarnings.length > 0) {
                NotificationSystem.showValidationWarnings(validationWarnings, 'en el fragmento');
            }

            // Mostrar advertencia de impacto alto
            if (changeImpact.level === 'high') {
                showHighImpactWarning(mode, changeImpact);
            } else {
                const modifiedCode = applyCodeChanges(mode);
                showExportDialog(modifiedCode, validationWarnings);
            }
        }

        function showHighImpactWarning(mode, changeImpact) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>‚ö†Ô∏è Cambio de Alto Impacto Detectado</h3>
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-content">
                        <div class="validation-warnings">
                            <div class="validation-warning">‚ö†Ô∏è Este cambio afectar√° ${changeImpact.changes.totalChanges} l√≠neas</div>
                            <div class="validation-warning">‚ö†Ô∏è Se reemplazar√°n ${state.chosen.endLine - state.chosen.startLine + 1} l√≠neas de c√≥digo</div>
                            <div class="validation-warning">üîç Revisa cuidadosamente que esta es la secci√≥n correcta</div>
                        </div>
                        <p>¬øEst√°s seguro de que quieres continuar con este cambio?</p>
                        <div class="action-buttons" style="margin-top: 1rem;">
                            <button class="btn btn-danger" onclick="proceedWithChange('${mode}')">S√≠, Continuar</button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function proceedWithChange(mode) {
            document.querySelector('.modal-overlay').remove();
            const modifiedCode = applyCodeChanges(mode);
            const validationWarnings = CodeValidator.validateSyntax(insertEl.value);
            showExportDialog(modifiedCode, validationWarnings);
        }

        function applyCodeChanges(mode) {
            const lines = originalEl.value.split('\n');
            const insertContent = insertEl.value;
            const startIndex = state.chosen.startLine - 1;
            const endIndex = state.chosen.endLine;
            
            let modifiedLines;

            switch (mode) {
                case 'replace':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(endIndex)
                    ];
                    break;
                case 'above':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(startIndex)
                    ];
                    break;
                case 'below':
                    modifiedLines = [
                        ...lines.slice(0, endIndex),
                        insertContent,
                        ...lines.slice(endIndex)
                    ];
                    break;
                default:
                    modifiedLines = lines;
            }

            return modifiedLines.join('\n');
        }

        function showExportDialog(modifiedCode, validationWarnings = []) {
            state.modifiedContent = modifiedCode;
            
            // Validar el c√≥digo resultante
            const finalWarnings = CodeValidator.validateSyntax(modifiedCode);
            const allWarnings = [...validationWarnings, ...finalWarnings];
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Confirmar Cambios ${allWarnings.length > 0 ? '‚ö†Ô∏è' : ''}</h3>
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-content">
                        ${allWarnings.length > 0 ? `
                            <div class="validation-warnings">
                                <h4>Advertencias de Validaci√≥n:</h4>
                                ${allWarnings.map(warning => `
                                    <div class="validation-warning">‚ö†Ô∏è ${warning}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <p>Revisa los cambios antes de descargar:</p>
                        
                        <div class="code-comparison">
                            <div class="code-block">
                                <div class="code-block-header">Original (${state.currentFiles.original.name})</div>
                                <div class="code-block-content">${highlightChanges(state.originalContent, 'original')}</div>
                            </div>
                            <div class="code-block">
                                <div class="code-block-header">Modificado</div>
                                <div class="code-block-content">${highlightChanges(modifiedCode, 'modified')}</div>
                            </div>
                        </div>

                        <div class="export-options">
                            <label>
                                Nombre de archivo:
                                <input type="text" class="filename-input" id="exportFilename" 
                                       value="${generateSmartFilename(state.currentFiles.original.name)}" 
                                       onchange="validateFilename(this)">
                            </label>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="confirmExport()">Descargar ${allWarnings.length > 0 ? '‚ö†Ô∏è' : ''}</button>
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Funciones de validaci√≥n en tiempo real
        function validateOriginalCode() {
            const warnings = CodeValidator.validateSyntax(originalEl.value);
            if (warnings.length > 0) {
                setStatus('warning', 'Problemas en c√≥digo original');
            } else {
                setStatus('success', 'C√≥digo original v√°lido');
            }
        }

        function validateInsertCode() {
            const warnings = CodeValidator.validateSyntax(insertEl.value);
            if (warnings.length > 0) {
                setStatus('warning', 'Problemas en fragmento');
            }
        }

        // Gesti√≥n de archivos mejorada
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o de archivo
            if (file.size > 1024 * 1024) { // 1MB
                NotificationSystem.show('Archivo muy grande (>1MB). Considera usar archivos m√°s peque√±os.', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'original') {
                    originalEl.value = e.target.result;
                    state.originalContent = e.target.result;
                    state.currentFiles.original = {
                        name: file.name,
                        size: file.size,
                        path: file.name // En navegador, usamos el nombre como path
                    };
                    updateFileDisplay('original', file.name, file.size);
                } else {
                    insertEl.value = e.target.result;
                    state.currentFiles.insert = {
                        name: file.name,
                        size: file.size,
                        path: file.name
                    };
                    updateFileDisplay('insert', file.name, file.size);
                }
                
                // Validar el c√≥digo cargado
                const warnings = CodeValidator.validateSyntax(e.target.result);
                if (warnings.length > 0) {
                    NotificationSystem.showValidationWarnings(warnings, `en ${file.name}`);
                }
                
                NotificationSystem.show(`Archivo ${file.name} cargado (${(file.size/1024).toFixed(1)}KB)`, 'success');
            };
            reader.readAsText(file);
        }

        function updateFileDisplay(type, filename, size) {
            const sizeText = size > 1024 ? `${(size/1024).toFixed(1)}KB` : `${size}B`;
            
            if (type === 'original') {
                originalFileName.textContent = filename;
                originalFileSize.textContent = sizeText;
            } else {
                insertFileName.textContent = filename;
                insertFileSize.textContent = sizeText;
            }
        }

        // ... (resto de las funciones se mantienen similares pero mejoradas)

        function setStatus(status, message) {
            state.status = status;
            statusText.textContent = message;
            statusDot.className = 'status-dot ' + status;
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            setStatus('success', 'Listo para usar');
            RobustHistoryManager.updateDisplay();
            
            // Cargar historial si existe
            try {
                const stored = localStorage.getItem('codeinsertor_history');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.data && Array.isArray(data.data)) {
                        state.history = data.data.slice(-state.maxHistory);
                        RobustHistoryManager.updateDisplay();
                    }
                }
            } catch (error) {
                console.log('No se pudo cargar historial previo:', error);
            }

            NotificationSystem.show('CodeInsertor v1.3 - Con validaciones inteligentes!', 'success');
        });

        // Funciones auxiliares (se mantienen iguales)
        function highlightChanges(content, type) {
            return content.split('\n').map(line => {
                if (type === 'modified' && !state.originalContent.includes(line)) {
                    return `<span class="diff-added">${line}</span>`;
                }
                return line;
            }).join('\n');
        }

        function generateSmartFilename(originalName = 'codigo') {
            const baseName = originalName.replace(/\.[^/.]+$/, "");
            const extension = originalName.includes('.') ? originalName.split('.').pop() : 'txt';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            return `${baseName}-modificado-${timestamp}.${extension}`;
        }

        function validateFilename(input) {
            const invalidChars = /[<>:"/\\|?*]/g;
            if (invalidChars.test(input.value)) {
                input.style.borderColor = 'var(--error)';
                NotificationSystem.show('El nombre de archivo contiene caracteres inv√°lidos', 'error');
            } else {
                input.style.borderColor = 'var(--border)';
            }
        }

        function confirmExport() {
            const filenameInput = document.getElementById('exportFilename');
            const filename = filenameInput.value || generateSmartFilename(state.currentFiles.original.name);
            
            downloadText(state.modifiedContent, filename);
            RobustHistoryManager.pushHistory('exportaci√≥n con validaciones');
            
            document.querySelector('.modal-overlay').remove();
            NotificationSystem.show(`Archivo ${filename} descargado correctamente`, 'success');
        }

        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ... (resto de funciones auxiliares)
    </script>
</body>
</html>
