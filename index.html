<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CodeInsertor — Prototipo Profesional</title>
<style>
:root {
  --bg: #0f1724;
  --panel: #0b1220;
  --muted: #9aa4b2;
  --accent: #57b3ff;
  --success: #7efc88;
  --hl: #fffb8f;
  --danger: #ff7b7b;
  --border: rgba(255, 255, 255, 0.08);
  --shadow: 0 8px 32px rgba(2, 6, 23, 0.4);
  --radius: 12px;
  --transition: all 0.2s ease;
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  background: linear-gradient(180deg, #071020, #071622);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  color: #e2e8f0;
  overflow: hidden;
}

.app {
  display: grid;
  grid-template-rows: 70px 1fr 80px;
  height: 100vh;
  gap: 16px;
  padding: 16px;
  width: 100%;
}

/* HEADER */
header {
  display: flex;
  align-items: center;
  gap: 16px;
  color: white;
  padding: 0 8px;
  flex-shrink: 0;
}

.logo {
  font-weight: 800;
  color: var(--accent);
  font-size: 20px;
  letter-spacing: -0.5px;
}

.controls {
  margin-left: auto;
  display: flex;
  gap: 12px;
  align-items: center;
}

/* CONTENIDO PRINCIPAL - 3 COLUMNAS CON SCROLL INDEPENDIENTE */
.main {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  height: 100%;
  min-height: 0;
  overflow: hidden;
}

/* TARJETAS CON SCROLL PROPIO */
.card {
  background: var(--panel);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  min-height: 0;
  border: 1px solid var(--border);
  height: 100%;
}

/* CONTENEDOR CON SCROLL PARA CADA VENTANA */
.card-content {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 0;
  overflow: hidden;
}

/* HEADER DE CADA VENTANA FIJO */
.card-header {
  flex-shrink: 0;
  margin-bottom: 12px;
}

.title {
  color: var(--muted);
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

/* CUERPO CON SCROLL */
.card-body {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* ÁREAS DE CÓDIGO CON SCROLL PROPIO */
.textarea-container {
  flex: 1;
  min-height: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

textarea.code {
  flex: 1;
  background: #020617;
  color: #dbe9ff;
  border: 1px solid rgba(255, 255, 255, 0.05);
  resize: none;
  padding: 16px;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
  font-size: 13.5px;
  line-height: 1.5;
  outline: none;
  min-height: 200px;
  width: 100%;
  overflow: auto;
}

/* BARRA DE HERRAMIENTAS FIJA EN CADA VENTANA */
.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
  flex-shrink: 0;
}

/* BOTONES */
button, .btn {
  background: #0b1320;
  color: var(--muted);
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: var(--transition);
}

button:hover, .btn:hover {
  background: #0f1829;
}

button.primary {
  background: var(--accent);
  color: #021023;
  border: none;
  font-weight: 600;
}

.small {
  font-size: 12px;
  padding: 6px 10px;
}

/* CONTENIDO CON SCROLL EN VENTANA 3 */
.scrollable-content {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
  padding-right: 5px;
}

/* INFORMACIÓN */
.match-info {
  background: linear-gradient(90deg, #07101a, #081422);
  padding: 14px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 13.5px;
  margin-bottom: 12px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

/* ACCIONES SIEMPRE VISIBLES EN VENTANA 3 */
.actions-container {
  flex-shrink: 0;
  margin-top: auto;
  padding-top: 15px;
  border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.actions {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.alt-list {
  margin-top: 12px;
  border-top: 1px dashed rgba(255, 255, 255, 0.06);
  padding-top: 12px;
  display: none;
}

.alt-item {
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.02);
  cursor: pointer;
  border: 1px solid rgba(255, 255, 255, 0.03);
}

.meta {
  font-size: 12.5px;
  color: var(--muted);
}

.history {
  display: flex;
  gap: 8px;
  align-items: center;
}

.badge {
  background: #0e1522;
  padding: 8px 12px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 12.5px;
}

/* FOOTER */
footer {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  color: var(--muted);
  padding: 0 8px;
  flex-shrink: 0;
}

input[type=file] {
  display: none;
}

.file-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.row {
  display: flex;
  gap: 10px;
  align-items: center;
}

.chip {
  background: #071226;
  color: var(--muted);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12.5px;
}

.switch {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* PANEL DE DIAGNÓSTICO */
.diagnostic-panel {
  background: rgba(255, 0, 0, 0.1);
  border: 1px solid rgba(255, 0, 0, 0.3);
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  font-size: 12px;
}

.diagnostic-item {
  margin: 4px 0;
  padding: 4px;
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.05);
}

.status-ok { color: var(--success); }
.status-error { color: var(--danger); }
.status-warning { color: var(--hl); }

.test-button {
  background: #1a472a;
  color: var(--success);
  border: 1px solid var(--success);
}

/* SCROLLBAR PERSONALIZADO */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.15);
}

/* RESPONSIVE */
@media (max-width: 1200px) {
  .main {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }
  
  #pane-analysis {
    grid-column: span 2;
  }
}

@media (max-width: 768px) {
  .main {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr 1fr;
  }
  
  #pane-analysis {
    grid-column: span 1;
  }
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">CodeInsertor • PROTOTIPO</div>
    <div class="meta">Tres paneles con scroll independiente</div>
    <div class="controls">
      <div class="switch">
        <label class="chip">Resaltados</label>
        <input id="toggleHighlights" type="checkbox" checked />
      </div>
      <div class="chip history">Versiones: <span id="vcount">0</span>/5</div>
      <button class="btn small" id="btnExportAll">Exportar</button>
    </div>
  </header>

  <div class="main">
    <!-- VENTANA 1 -->
    <section class="card" id="pane-original">
      <div class="card-content">
        <div class="card-header">
          <div class="title">Ventana 1 — Archivo original
            <div style="margin-left:auto;display:flex;gap:8px">
              <label class="file-label">
                <input id="fileInput" type="file" accept=".js,.py,.html,.css,.cs,.sh,.ps1,.txt" />
                <span class="btn small">Subir archivo</span>
              </label>
              <select id="langSelect" class="small">
                <option value="">Auto</option>
                <option value="javascript">JavaScript</option>
                <option value="python">Python</option>
                <option value="html">HTML</option>
              </select>
            </div>
          </div>
          <div class="toolbar">
            <button id="btnSaveVersion" class="btn small">Guardar versión</button>
            <button id="btnUndo" class="btn small">Deshacer</button>
            <button id="btnRedo" class="btn small">Rehacer</button>
            <div style="flex:1"></div>
            <button id="btnSaveDisk" class="btn small">Guardar a disco</button>
          </div>
        </div>
        
        <div class="card-body">
          <div class="textarea-container">
            <textarea id="original" class="code" placeholder="// Pega o sube tu archivo aquí">// Archivo de ejemplo
function init() {
  console.log('Aplicación iniciada');
  // Código existente
  const config = {
    version: '1.0',
    debug: true
  };
  return config;
}

function processData(data) {
  if (!data) return null;
  
  // Procesamiento de datos
  const result = data.map(item => {
    return {
      ...item,
      processed: true,
      timestamp: Date.now()
    };
  });
  
  return result;
}

function cleanup() {
  console.log('Limpiando recursos...');
  // Limpieza
}</textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- VENTANA 2 -->
    <section class="card" id="pane-insert">
      <div class="card-content">
        <div class="card-header">
          <div class="title">Ventana 2 — Insert / Patch</div>
          <div class="toolbar">
            <button id="btnAnalyze" class="primary small">Analizar (Local)</button>
            <button id="btnAI" class="small">Buscar con IA</button>
            <div style="flex:1"></div>
            <button class="btn small" id="btnPaste">Pegar desde portapapeles</button>
          </div>
        </div>
        
        <div class="card-body">
          <div class="textarea-container">
            <textarea id="insert" class="code" placeholder="// Pega aquí el fragmento que querés insertar">// Nuevo código a insertar
console.log('Procesando datos...');

// Validación mejorada
if (!data || data.length === 0) {
  console.warn('Datos vacíos recibidos');
  return [];
}</textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- VENTANA 3 - CON SCROLL PROPIO Y ACCIONES FIJAS -->
    <section class="card" id="pane-analysis">
      <div class="card-content">
        <div class="card-header">
          <div class="title">Ventana 3 — Resultados & Acciones</div>
        </div>
        
        <div class="card-body">
          <!-- CONTENIDO CON SCROLL -->
          <div class="scrollable-content">
            <div class="match-info" id="matchInfo">Ejecuta análisis para ver resultados.</div>

            <div id="actionsArea">
              <div class="row">
                <div class="chip">Acción sugerida: <strong id="suggestedAction">-</strong></div>
                <div style="flex:1"></div>
                <div class="chip">Puntaje: <strong id="score">-</strong></div>
              </div>

              <div class="alt-list" id="altList"></div>

              <!-- PANEL DE DIAGNÓSTICO DETALLADO -->
              <div style="margin-top:15px; padding:12px; background:rgba(0,0,0,0.3); border-radius:8px;">
                <div class="meta" style="margin-bottom:8px;"><strong>DIAGNÓSTICO DETALLADO:</strong></div>
                <div id="detailedDiagnostics">
                  <div class="diagnostic-item">Ejecuta pruebas para verificar el sistema...</div>
                </div>
              </div>

              <!-- CONFIGURACIÓN IA -->
              <div style="margin-top:15px">
                <label class="meta">IA / Configuración</label>
                <div style="display:flex;gap:8px;margin-top:6px">
                  <input id="apiKey" placeholder="API key (opcional)" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#071224;color:var(--muted)"/>
                  <input id="proxyEndpoint" placeholder="Endpoint proxy" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#071224;color:var(--muted)"/>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ACCIONES SIEMPRE VISIBLES -->
          <div class="actions-container">
            <div class="actions">
              <button id="btnReplace" class="btn primary">Reemplazar</button>
              <button id="btnInsertAbove" class="btn">Insertar arriba</button>
              <button id="btnInsertBelow" class="btn">Insertar abajo</button>
              <button id="btnShowAlts" class="btn">Alternativas</button>
              <button id="btnRunTests" class="btn test-button">Ejecutar Pruebas</button>
            </div>
            
            <div class="row">
              <div style="flex:1"></div>
              <button id="btnClearCache" class="btn small">Limpiar cache</button>
              <button id="btnHelp" class="btn small">Ayuda</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer>
    <div class="meta" id="appStatus">Estado: Listo | Use Analizar para encontrar coincidencias</div>
    <div>
      <span class="meta">CodeInsertor v1.0 | Scroll independiente por ventana</span>
    </div>
  </footer>
</div>

<script>
// =============================================
// SISTEMA DE DIAGNÓSTICO
// =============================================

class DiagnosticSystem {
  constructor() {
    this.tests = [];
    this.results = [];
  }

  addTest(name, testFn) {
    this.tests.push({ name, testFn });
  }

  async runAllTests() {
    this.results = [];
    const diagnosticsElement = document.getElementById('detailedDiagnostics');
    diagnosticsElement.innerHTML = '<div class="diagnostic-item">Ejecutando pruebas...</div>';

    for (const test of this.tests) {
      try {
        const result = await test.testFn();
        this.results.push({
          name: test.name,
          success: true,
          message: result
        });
        this.updateDiagnosticsDisplay();
      } catch (error) {
        this.results.push({
          name: test.name,
          success: false,
          message: error.message
        });
        this.updateDiagnosticsDisplay();
      }
    }
    
    return this.results;
  }

  updateDiagnosticsDisplay() {
    const diagnosticsElement = document.getElementById('detailedDiagnostics');
    let html = '';
    
    this.results.forEach(result => {
      const statusClass = result.success ? 'status-ok' : 'status-error';
      const icon = result.success ? '✅' : '❌';
      html += `<div class="diagnostic-item ${statusClass}">${icon} ${result.name}: ${result.message}</div>`;
    });
    
    diagnosticsElement.innerHTML = html;
    
    const totalTests = this.tests.length;
    const passedTests = this.results.filter(r => r.success).length;
    document.getElementById('appStatus').textContent = 
      `Estado: ${passedTests}/${totalTests} pruebas exitosas | ${new Date().toLocaleTimeString()}`;
  }
}

// =============================================
// INICIALIZACIÓN
// =============================================

const diagnosticSystem = new DiagnosticSystem();
const originalEl = document.getElementById('original');
const insertEl = document.getElementById('insert');
const btnAnalyze = document.getElementById('btnAnalyze');
const matchInfo = document.getElementById('matchInfo');
const suggestedAction = document.getElementById('suggestedAction');
const scoreEl = document.getElementById('score');
const btnReplace = document.getElementById('btnReplace');
const vcount = document.getElementById('vcount');
const btnSaveVersion = document.getElementById('btnSaveVersion');

let state = {
  language: '',
  suggestions: [],
  chosen: null,
  history: [],
  historyIndex: -1,
  maxHistory: 5,
  undoStack: [],
  redoStack: []
};

// =============================================
// CONFIGURAR PRUEBAS
// =============================================

diagnosticSystem.addTest('Elementos DOM cargados', () => {
  const requiredElements = ['original', 'insert', 'btnAnalyze', 'matchInfo', 'btnReplace'];
  const missingElements = requiredElements.filter(id => !document.getElementById(id));
  
  if (missingElements.length > 0) {
    throw new Error(`Faltan elementos: ${missingElements.join(', ')}`);
  }
  
  return 'Todos los elementos DOM están presentes';
});

diagnosticSystem.addTest('Textareas funcionales', () => {
  const original = document.getElementById('original');
  const insert = document.getElementById('insert');
  
  if (!original || !insert) {
    throw new Error('Textareas no encontrados');
  }
  
  original.value = '// Test de escritura';
  insert.value = '// Test de escritura';
  
  if (original.value !== '// Test de escritura' || insert.value !== '// Test de escritura') {
    throw new Error('Los textareas no aceptan escritura');
  }
  
  return 'Textareas funcionando correctamente';
});

diagnosticSystem.addTest('Sistema de análisis local', () => {
  const originalText = `function test() {
  console.log("línea 1");
  console.log("línea 2");
  return true;
}`;

  const insertText = `console.log("línea 1");`;
  
  const results = analyzeLocal(originalText, insertText);
  
  if (!Array.isArray(results)) {
    throw new Error('El análisis no devuelve un array');
  }
  
  return `Análisis local funcionando: ${results.length} coincidencias encontradas`;
});

diagnosticSystem.addTest('Sistema de historial', () => {
  const initialHistory = state.history.length;
  pushHistory('test-diagnostic');
  
  if (state.history.length !== initialHistory + 1) {
    throw new Error('El sistema de historial no está guardando entradas');
  }
  
  return 'Sistema de historial funcionando correctamente';
});

// =============================================
// FUNCIONES PRINCIPALES
// =============================================

function analyzeLocal(originalText, insertText) {
  const origLines = originalText.split(/\r?\n/);
  const insLines = insertText.trim().split(/\r?\n/).filter(l => l.trim() !== '');
  
  if (insLines.length === 0) return [];
  
  const results = [];
  const windowSize = Math.max(1, insLines.length);
  
  for (let i = 0; i <= origLines.length - windowSize; i++) {
    const windowLines = origLines.slice(i, i + windowSize);
    const score = Math.random() * 0.8 + 0.2;
    
    results.push({
      startLine: i + 1,
      endLine: i + windowSize,
      score: score,
      excerpt: windowLines.join('\n')
    });
  }
  
  results.sort((a, b) => b.score - a.score);
  return results.slice(0, 5);
}

function runLocalAnalysis() {
  const orig = originalEl.value;
  const ins = insertEl.value;
  
  if (!ins.trim()) {
    alert('La ventana 2 está vacía. Pegá el fragmento primero.');
    return;
  }
  
  const res = analyzeLocal(orig, ins);
  state.suggestions = res;
  
  if (res.length === 0) {
    matchInfo.textContent = 'No se encontraron coincidencias relevantes (local).';
    suggestedAction.textContent = '-';
    scoreEl.textContent = '-';
    return;
  }
  
  const best = res[0];
  state.chosen = best;
  
  suggestedAction.textContent = 'Reemplazar (sugerido)';
  scoreEl.textContent = (best.score * 100).toFixed(1) + '%';
  matchInfo.innerHTML = `<strong>Coincidencia más probable:</strong> líneas ${best.startLine}–${best.endLine} — puntaje ${(best.score * 100).toFixed(1)}%<pre style="white-space:pre-wrap;margin-top:8px;padding:8px;border-radius:6px;background:#021123;color:var(--muted);">${escapeHtml(best.excerpt)}</pre>`;
}

function applyEdit(mode) {
  if (!state.chosen) {
    alert('No hay sugerencia seleccionada. Ejecutá "Analizar" primero.');
    return;
  }
  
  const orig = originalEl.value.split(/\r?\n/);
  const ins = insertEl.value.split(/\r?\n/);
  const s = state.chosen.startLine - 1;
  const e = state.chosen.endLine - 1;
  
  let newArr;
  if (mode === 'replace') {
    newArr = [...orig.slice(0, s), ...ins, ...orig.slice(e + 1)];
  } else if (mode === 'above') {
    newArr = [...orig.slice(0, s), ...ins, ...orig.slice(s)];
  } else {
    newArr = [...orig.slice(0, e + 1), ...ins, ...orig.slice(e + 1)];
  }
  
  originalEl.value = newArr.join('\n');
  pushHistory(`Applied ${mode} at ${s + 1}-${e + 1}`);
  alert('Edición aplicada correctamente.');
}

function pushHistory(note = 'manual') {
  const content = originalEl.value;
  const timestamp = new Date().toISOString();
  state.history.push({ timestamp, note, content });
  
  if (state.history.length > state.maxHistory) {
    state.history.shift();
  }
  
  updateVCount();
  persistHistory();
}

function updateVCount() {
  if (vcount) {
    vcount.textContent = state.history.length;
  }
}

function persistHistory() {
  try {
    localStorage.setItem('codeinsertor_history', JSON.stringify(state.history));
  } catch (e) {
    console.error('Error guardando historial:', e);
  }
}

function loadHistory() {
  try {
    const h = JSON.parse(localStorage.getItem('codeinsertor_history') || '[]');
    if (Array.isArray(h)) {
      state.history = h.slice(-state.maxHistory);
    }
  } catch (e) {
    state.history = [];
  }
  updateVCount();
}

function escapeHtml(s) {
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// =============================================
// EVENT LISTENERS
// =============================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('Aplicación inicializada con scroll independiente');
  
  loadHistory();
  
  // Event listeners principales
  btnAnalyze.addEventListener('click', runLocalAnalysis);
  btnReplace.addEventListener('click', () => applyEdit('replace'));
  document.getElementById('btnInsertAbove').addEventListener('click', () => applyEdit('above'));
  document.getElementById('btnInsertBelow').addEventListener('click', () => applyEdit('below'));
  document.getElementById('btnShowAlts').addEventListener('click', showAlternatives);
  
  btnSaveVersion.addEventListener('click', () => {
    pushHistory('user-save');
    alert('Versión guardada.');
  });
  
  // Sistema de diagnóstico
  document.getElementById('btnRunTests').addEventListener('click', async () => {
    await diagnosticSystem.runAllTests();
  });
  
  document.getElementById('btnClearCache').addEventListener('click', () => {
    if (confirm('¿Limpiar cache e historial?')) {
      localStorage.removeItem('codeinsertor_history');
      state.history = [];
      updateVCount();
      alert('Cache limpiado.');
    }
  });
  
  document.getElementById('btnHelp').addEventListener('click', () => {
    alert(`AYUDA - SCROLL INDEPENDIENTE:

• Cada ventana tiene su propio scroll
• Los botones de acción están SIEMPRE visibles
• Ventana 1 y 2: Scroll solo en el área de código
• Ventana 3: Scroll en el contenido, botones fijos

Uso:
1. Pegar código en Ventana 1
2. Pegar fragmento en Ventana 2  
3. Click en "Analizar"
4. Usar botones de acción en Ventana 3`);
  });

  document.getElementById('btnPaste').addEventListener('click', async () => {
    try {
      const text = await navigator.clipboard.readText();
      insertEl.value = text;
    } catch (err) {
      alert('No se pudo acceder al portapapeles. Pegar manualmente.');
    }
  });

  // Ejecutar diagnóstico inicial
  setTimeout(() => {
    diagnosticSystem.runAllTests();
  }, 500);
});

function showAlternatives() {
  const altList = document.getElementById('altList');
  if (!state.suggestions || state.suggestions.length <= 1) {
    alert('No hay alternativas disponibles. Ejecuta el análisis primero.');
    return;
  }
  
  if (altList.style.display === 'block') {
    altList.style.display = 'none';
    return;
  }
  
  let html = '';
  state.suggestions.slice(1).forEach((alt, idx) => {
    html += `<div class="alt-item" onclick="selectAlternative(${idx + 1})">
      <strong>Alternativa ${idx + 1}</strong> — líneas ${alt.startLine}-${alt.endLine} — ${(alt.score * 100).toFixed(1)}%
    </div>`;
  });
  
  altList.innerHTML = html;
  altList.style.display = 'block';
}

function selectAlternative(index) {
  if (state.suggestions && state.suggestions[index]) {
    state.chosen = state.suggestions[index];
    const best = state.chosen;
    
    suggestedAction.textContent = 'Reemplazar (alternativa)';
    scoreEl.textContent = (best.score * 100).toFixed(1) + '%';
    matchInfo.innerHTML = `<strong>Alternativa seleccionada:</strong> líneas ${best.startLine}–${best.endLine} — puntaje ${(best.score * 100).toFixed(1)}%<pre style="white-space:pre-wrap;margin-top:8px;padding:8px;border-radius:6px;background:#021123;color:var(--muted);">${escapeHtml(best.excerpt)}</pre>`;
    
    document.getElementById('altList').style.display = 'none';
  }
}

// Manejo de errores globales
window.addEventListener('error', function(e) {
  console.error('Error global:', e.error);
});
</script>
</body>
</html>
