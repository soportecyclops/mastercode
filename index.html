<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CodeInsertor — Prototipo Profesional</title>
<style>
:root {
  --bg: #0f1724;
  --panel: #0b1220;
  --muted: #9aa4b2;
  --accent: #57b3ff;
  --success: #7efc88;
  --hl: #fffb8f;
  --danger: #ff7b7b;
  --border: rgba(255, 255, 255, 0.08);
  --shadow: 0 8px 32px rgba(2, 6, 23, 0.4);
  --radius: 12px;
  --transition: all 0.2s ease;
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  background: linear-gradient(180deg, #071020, #071622);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  color: #e2e8f0;
  overflow: hidden;
}

.app {
  display: grid;
  grid-template-rows: 70px 1fr 100px;
  height: 100vh;
  gap: 16px;
  padding: 16px;
}

/* HEADER MEJORADO */
header {
  display: flex;
  align-items: center;
  gap: 16px;
  color: white;
  padding: 0 8px;
}

.logo {
  font-weight: 800;
  color: var(--accent);
  font-size: 20px;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo::before {
  content: "⚡";
  font-size: 18px;
}

.controls {
  margin-left: auto;
  display: flex;
  gap: 12px;
  align-items: center;
}

/* CONTENIDO PRINCIPAL - 3 COLUMNAS IGUALES */
.main {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  height: 100%;
  min-height: 0;
}

/* TARJETAS MEJORADAS */
.card {
  background: var(--panel);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  min-height: 0;
  border: 1px solid var(--border);
  transition: var(--transition);
}

.card:hover {
  box-shadow: 0 12px 40px rgba(2, 6, 23, 0.5);
}

.title {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* ÁREAS DE CÓDIGO MEJORADAS */
textarea.code {
  flex: 1;
  background: #020617;
  color: #dbe9ff;
  border: 1px solid rgba(255, 255, 255, 0.05);
  resize: none;
  padding: 16px;
  border-radius: 8px;
  font-family: 'Fira Code', 'SFMono-Regular', 'Consolas', 'Liberation Mono', 'Menlo', monospace;
  font-size: 13.5px;
  line-height: 1.5;
  outline: none;
  transition: var(--transition);
  min-height: 0;
}

textarea.code:focus {
  border-color: rgba(87, 179, 255, 0.3);
  box-shadow: 0 0 0 3px rgba(87, 179, 255, 0.1);
}

/* BARRA DE HERRAMIENTAS MEJORADA */
.toolbar {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

/* BOTONES MEJORADOS */
button, .btn {
  background: #0b1320;
  color: var(--muted);
  border: 1px solid rgba(255, 255, 255, 0.08);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

button:hover, .btn:hover {
  background: #0f1829;
  border-color: rgba(255, 255, 255, 0.12);
  transform: translateY(-1px);
}

button.primary {
  background: linear-gradient(90deg, var(--accent), #3da7ff);
  color: #021023;
  border: none;
  font-weight: 600;
}

button.primary:hover {
  background: linear-gradient(90deg, #6ac1ff, #4fb0ff);
  box-shadow: 0 4px 12px rgba(87, 179, 255, 0.3);
}

.small {
  font-size: 12px;
  padding: 6px 10px;
}

.panel-body {
  overflow: auto;
  flex: 1;
  min-height: 0;
}

/* INFORMACIÓN DE COINCIDENCIA MEJORADA */
.match-info {
  background: linear-gradient(90deg, #07101a, #081422);
  padding: 14px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 13.5px;
  margin-bottom: 12px;
  border: 1px solid rgba(255, 255, 255, 0.05);
  line-height: 1.5;
}

.highlight {
  background: rgba(255, 255, 0, 0.12);
  outline: 2px solid rgba(255, 255, 0, 0.12);
  display: block;
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.toggle {
  display: flex;
  gap: 8px;
  align-items: center;
}

.alt-list {
  margin-top: 12px;
  border-top: 1px dashed rgba(255, 255, 255, 0.06);
  padding-top: 12px;
  display: none;
}

.alt-item {
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  background: rgba(255, 255, 255, 0.02);
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid rgba(255, 255, 255, 0.03);
}

.alt-item:hover {
  background: rgba(255, 255, 255, 0.05);
  transform: translateX(4px);
}

.meta {
  font-size: 12.5px;
  color: var(--muted);
  line-height: 1.5;
}

.history {
  display: flex;
  gap: 8px;
  align-items: center;
}

.badge {
  background: #0e1522;
  padding: 8px 12px;
  border-radius: 8px;
  color: var(--muted);
  font-size: 12.5px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

/* FOOTER MEJORADO */
footer {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  color: var(--muted);
  padding: 0 8px;
}

.danger {
  color: var(--danger);
}

input[type=file] {
  display: none;
}

.file-label {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.row {
  display: flex;
  gap: 10px;
  align-items: center;
}

.chip {
  background: #071226;
  color: var(--muted);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12.5px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.switch {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* INPUTS MEJORADOS */
input[type="text"], input[type="password"], select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  background: #071224;
  color: var(--muted);
  font-size: 13px;
  transition: var(--transition);
}

input[type="text"]:focus, input[type="password"]:focus, select:focus {
  outline: none;
  border-color: rgba(87, 179, 255, 0.4);
  box-shadow: 0 0 0 3px rgba(87, 179, 255, 0.1);
}

/* CHECKBOX MEJORADO */
input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--accent);
  cursor: pointer;
}

/* SCROLLBAR PERSONALIZADO */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.15);
}

/* RESPONSIVE ADJUSTMENTS */
@media (max-width: 1200px) {
  .main {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }
  
  #pane-analysis {
    grid-column: span 2;
  }
}

@media (max-width: 768px) {
  .main {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr 1fr 1fr;
  }
  
  #pane-analysis {
    grid-column: span 1;
  }
  
  .app {
    grid-template-rows: auto 1fr auto;
    gap: 12px;
    padding: 12px;
  }
  
  header, footer {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .controls {
    margin-left: 0;
    width: 100%;
    justify-content: space-between;
  }
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">CodeInsertor</div>
    <div class="meta">Prototipo — Tres paneles: búsqueda local + IA (opcional)</div>
    <div class="controls">
      <div class="switch">
        <label class="chip">Resaltados</label>
        <input id="toggleHighlights" type="checkbox" checked />
      </div>
      <div class="chip history">Versiones guardadas: <span id="vcount">0</span>/5</div>
      <button class="btn small" id="btnExportAll">Exportar</button>
    </div>
  </header>

  <div class="main">
    <!-- VENTANA 1 -->
    <section class="card" id="pane-original">
      <div class="title">Ventana 1 — Archivo original
        <div style="margin-left:auto;display:flex;gap:8px">
          <label class="file-label">
            <input id="fileInput" type="file" accept=".js,.py,.html,.css,.cs,.sh,.ps1,.txt" />
            <span class="btn small">Subir archivo</span>
          </label>
          <select id="langSelect" class="small">
            <option value="">Detección automática</option>
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="csharp">C#</option>
            <option value="bash">Bash</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnSaveVersion" class="btn small">Guardar versión</button>
        <button id="btnUndo" class="btn small">Deshacer</button>
        <button id="btnRedo" class="btn small">Rehacer</button>
        <div style="flex:1"></div>
        <label class="file-label"><input id="saveToDiskInput" type="button" /><span id="btnSaveDisk" class="btn small">Guardar a disco</span></label>
      </div>
      <div class="panel-body">
        <textarea id="original" class="code" placeholder="// Pega o sube tu archivo aquí"></textarea>
      </div>
    </section>

    <!-- VENTANA 2 -->
    <section class="card" id="pane-insert">
      <div class="title">Ventana 2 — Insert / Patch</div>
      <div class="toolbar">
        <button id="btnAnalyze" class="primary small">Analizar (Local)</button>
        <button id="btnAI" class="small">Buscar con IA (opcional)</button>
        <div style="flex:1"></div>
        <label class="file-label"><input id="pasteBtn" type="button" /><span class="btn small" id="btnPaste">Pegar desde portapapeles</span></label>
      </div>
      <div class="panel-body">
        <textarea id="insert" class="code" placeholder="// Pega aquí el fragmento que querés insertar o con el que quieras reemplazar"></textarea>
      </div>
    </section>

    <!-- VENTANA 3 -->
    <section class="card" id="pane-analysis">
      <div class="title">Ventana 3 — Resultados & Acciones</div>
      <div class="match-info" id="matchInfo">Aún no se realizó un análisis.</div>

      <div id="actionsArea" style="display:block">
        <div class="row">
          <div class="chip">Acción sugerida: <strong id="suggestedAction">-</strong></div>
          <div style="flex:1"></div>
          <div class="chip">Puntaje: <strong id="score">-</strong></div>
        </div>

        <div class="actions">
          <button id="btnReplace" class="btn">Reemplazar</button>
          <button id="btnInsertAbove" class="btn">Insertar arriba</button>
          <button id="btnInsertBelow" class="btn">Insertar abajo</button>
          <button id="btnShowAlts" class="btn">Mostrar coincidencias alternativas</button>
        </div>

        <div class="alt-list" id="altList"></div>

        <div style="margin-top:10px">
          <label class="meta">Modo de ayuda visual</label>
          <div><input id="helpToggle" type="checkbox" checked /> Mostrar ayudas visuales y textos</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="meta">IA / Configuración</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="apiKey" placeholder="(opcional, inseguro en browser) Pegar API key" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#071224;color:var(--muted)"/>
          <input id="proxyEndpoint" placeholder="o endpoint proxy (recomendado)" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#071224;color:var(--muted)"/>
        </div>
        <div class="meta" style="margin-top:6px">Recomendación: usar un pequeño backend como proxy para no exponer tu API key en el navegador.</div>
      </div>
    </section>
  </div>

  <footer>
    <div class="meta">Tips: detecta lenguaje por extensión; activar/desactivar resaltado; historial local (IndexedDB) hasta 5 versiones.</div>
    <div>
      <button id="btnClearCache" class="btn small">Limpiar cache</button>
      <button id="btnHelp" class="btn small">Ayuda</button>
    </div>
  </footer>
</div>

<script>
/* ============================
   Utilidades y estado global
   ============================ */
const originalEl = document.getElementById('original');
const insertEl = document.getElementById('insert');
const btnAnalyze = document.getElementById('btnAnalyze');
const btnAI = document.getElementById('btnAI');
const langSelect = document.getElementById('langSelect');
const fileInput = document.getElementById('fileInput');
const btnShowAlts = document.getElementById('btnShowAlts');
const altList = document.getElementById('altList');
const matchInfo = document.getElementById('matchInfo');
const suggestedAction = document.getElementById('suggestedAction');
const scoreEl = document.getElementById('score');
const btnReplace = document.getElementById('btnReplace');
const btnInsertAbove = document.getElementById('btnInsertAbove');
const btnInsertBelow = document.getElementById('btnInsertBelow');
const vcount = document.getElementById('vcount');
const btnSaveVersion = document.getElementById('btnSaveVersion');
const btnUndo = document.getElementById('btnUndo');
const btnRedo = document.getElementById('btnRedo');
const btnSaveDisk = document.getElementById('btnSaveDisk');
const apiKeyInput = document.getElementById('apiKey');
const proxyInput = document.getElementById('proxyEndpoint');
const toggleHighlights = document.getElementById('toggleHighlights');
const helpToggle = document.getElementById('helpToggle');
const btnExportAll = document.getElementById('btnExportAll');
const btnClearCache = document.getElementById('btnClearCache');
const pasteBtn = document.getElementById('btnPaste');

let state = {
  language: '',
  suggestions: [], // array of {startLine, endLine, score, excerpt}
  chosen: null,
  history: [], // {timestamp, content, diffLines}
  historyIndex: -1,
  maxHistory: 5,
  undoStack: [],
  redoStack: []
};

/* ============================
   Detección de lenguaje simple
   ============================ */
function detectLanguageFromFilename(name){
  if(!name) return '';
  const ext = name.split('.').pop().toLowerCase();
  const map = {js:'javascript',py:'python',html:'html',htm:'html',css:'css',cs:'csharp',sh:'bash',ps1:'powershell',txt:'text'};
  return map[ext] || '';
}
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if(!f) return;
  const text = await f.text();
  originalEl.value = text;
  const lang = detectLanguageFromFilename(f.name);
  if(lang) langSelect.value = lang;
  pushHistory(`Loaded ${f.name}`);
});

/* ============================
   Pegar desde portapapeles
   ============================ */
pasteBtn.addEventListener('click', async ()=>{
  try{
    const t = await navigator.clipboard.readText();
    insertEl.value = t;
  }catch(err){
    alert('No se pudo acceder al portapapeles. Pegar manualmente.');
  }
});

/* ============================
   Similitud local (offline)
   - estrategia: token Jaccard por línea + ventana
   ============================ */

function tokenize(s){
  return s.toLowerCase().split(/[^a-z0-9_]+/).filter(Boolean);
}
function jaccard(a,b){
  if(a.length===0 || b.length===0) return 0;
  const A = new Set(a), B = new Set(b);
  const inter = [...A].filter(x=>B.has(x)).length;
  const uni = new Set([...A,...B]).size;
  return inter/uni;
}

function analyzeLocal(originalText, insertText){
  const origLines = originalText.split(/\r?\n/);
  const insLines = insertText.trim().split(/\r?\n/).filter(l=>l.trim()!=='');
  if(insLines.length===0) return [];
  const insTokens = insLines.map(l=>tokenize(l));
  const insTokensFlat = insLines.map(l=>tokenize(l)).flat();

  const results = [];
  const windowSize = Math.max(1, insLines.length);
  for(let i=0;i<=origLines.length-windowSize;i++){
    const windowLines = origLines.slice(i,i+windowSize);
    const windowTokens = windowLines.map(l=>tokenize(l)).flat();
    // score: token overlap + average line jaccard
    const overlap = jaccard(windowTokens, insTokensFlat);
    // line wise avg
    let lineScoreSum = 0;
    for(let j=0;j<windowSize;j++){
      const a = tokenize(windowLines[j]||'');
      const b = tokenize(insLines[j]||'');
      lineScoreSum += jaccard(a,b);
    }
    const avgLine = lineScoreSum / windowSize;
    const score = 0.6*overlap + 0.4*avgLine; // weights tuned heuristically
    results.push({startLine:i+1,endLine:i+windowSize,score,excerpt:windowLines.join('\n')});
  }
  // sort by score desc
  results.sort((a,b)=>b.score-a.score);
  return results.slice(0,10); // top 10
}

/* ============================
   UI: análisis y mostrar sugerencia
   ============================ */
btnAnalyze.addEventListener('click', ()=>{
  runLocalAnalysis();
});
async function runLocalAnalysis(){
  const orig = originalEl.value;
  const ins = insertEl.value;
  if(!ins.trim()){ alert('La ventana 2 está vacía. Pegá el fragmento primero.'); return; }
  const res = analyzeLocal(orig, ins);
  state.suggestions = res;
  if(res.length===0){
    matchInfo.textContent = 'No se encontraron coincidencias relevantes (local).';
    suggestedAction.textContent = '-';
    scoreEl.textContent = '-';
    altList.style.display='none';
    return;
  }
  // la coincidencia más probable
  const best = res[0];
  state.chosen = best;
  showBestMatch(best);
  // preparar alt list but hide
  renderAltList(res.slice(1));
}

function showBestMatch(best){
  suggestedAction.textContent = 'Reemplazar (sugerido)';
  scoreEl.textContent = (best.score*100).toFixed(1)+'%';
  matchInfo.innerHTML = `<strong>Coincidencia más probable:</strong> líneas ${best.startLine}–${best.endLine} — puntaje ${(best.score*100).toFixed(1)}%<pre style="white-space:pre-wrap;margin-top:8px;padding:8px;border-radius:6px;background:#021123;color:var(--muted);">${escapeHtml(best.excerpt)}</pre>`;
  // resaltado: vamos a envolver las líneas en el textarea mediante overlay sencillo (aquí simulamos con selección)
  highlightLines(best.startLine, best.endLine);
  altList.style.display='none';
}

/* ============================
   Alt list
   ============================ */
btnShowAlts.addEventListener('click', ()=>{
  if(altList.style.display==='block'){ altList.style.display='none'; return; }
  if(state.suggestions.length>1){
    renderAltList(state.suggestions.slice(1));
    altList.style.display='block';
  }else{
    altList.innerHTML = '<div class="meta">No hay coincidencias alternativas.</div>';
    altList.style.display='block';
  }
});
function renderAltList(list){
  altList.innerHTML = '';
  list.forEach((it,idx)=>{
    const div = document.createElement('div');
    div.className='alt-item';
    div.innerHTML = `<div><strong>Alternativa ${idx+1}</strong> — líneas ${it.startLine}-${it.endLine} — ${(it.score*100).toFixed(1)}%</div><pre style="white-space:pre-wrap;margin-top:6px">${escapeHtml(it.excerpt)}</pre>`;
    div.onclick = ()=>{ state.chosen = it; showBestMatch(it); };
    altList.appendChild(div);
  });
}

/* ============================
   Resaltado y selección (Opción C)
   - Notar: textarea no permite HTML; haremos selección de líneas aproximada
   ============================ */
function highlightLines(startLine, endLine){
  if(!toggleHighlights.checked){ return; }
  const lines = originalEl.value.split(/\r?\n/);
  let charStart = 0;
  for(let i=0;i<startLine-1;i++) charStart += lines[i].length + 1;
  let charEnd = charStart;
  for(let i=startLine-1;i<endLine;i++) charEnd += (lines[i] ? lines[i].length : 0) + 1;
  originalEl.focus();
  originalEl.setSelectionRange(charStart, Math.max(charStart+1,charEnd));
  // scroll into view
  const textarea = originalEl;
  const approxLineHeight = 18;
  textarea.scrollTop = (startLine-3) * approxLineHeight;
}

/* ============================
   Reemplazo / Insert
   ============================ */
btnReplace.addEventListener('click', ()=>{
  applyEdit('replace');
});
btnInsertAbove.addEventListener('click', ()=> applyEdit('above'));
btnInsertBelow.addEventListener('click', ()=> applyEdit('below'));

function applyEdit(mode){
  if(!state.chosen){ alert('No hay sugerencia seleccionada. Ejecutá "Analizar" primero.'); return; }
  const orig = originalEl.value.split(/\r?\n/);
  const ins = insertEl.value.split(/\r?\n/);
  const s = state.chosen.startLine-1;
  const e = state.chosen.endLine-1;
  // save before change
  pushUndo(orig.join('\n'));
  let newArr;
  if(mode==='replace'){
    newArr = [...orig.slice(0,s), ...ins, ...orig.slice(e+1)];
  }else if(mode==='above'){
    newArr = [...orig.slice(0,s), ...ins, ...orig.slice(s)];
  }else{
    newArr = [...orig.slice(0,e+1), ...ins, ...orig.slice(e+1)];
  }
  originalEl.value = newArr.join('\n');
  // update history
  pushHistory(`Applied ${mode} at ${s+1}-${e+1}`);
  alert('Edición aplicada. Revisa y guarda versión si corresponde.');
}

/* ============================
   Undo/Redo simple
   ============================ */
function pushUndo(content){
  state.undoStack.push(content);
  if(state.undoStack.length>50) state.undoStack.shift();
}
btnUndo.addEventListener('click', ()=>{
  if(state.undoStack.length===0){ alert('Nada para deshacer'); return; }
  const last = state.undoStack.pop();
  state.redoStack.push(originalEl.value);
  originalEl.value = last;
});
btnRedo.addEventListener('click', ()=>{
  if(state.redoStack.length===0){ alert('Nada para rehacer'); return; }
  const last = state.redoStack.pop();
  state.undoStack.push(originalEl.value);
  originalEl.value = last;
});

/* ============================
   Historial de versiones (IndexedDB simple fallback to localStorage)
   ============================ */
function pushHistory(note='manual'){
  const content = originalEl.value;
  const timestamp = new Date().toISOString();
  const diffLines = computeDiffLines(content, getLastHistoryContent());
  state.history.push({timestamp,note,content,diffLines});
  if(state.history.length>state.maxHistory) state.history.shift();
  state.historyIndex = state.history.length-1;
  updateVCount();
  persistHistory();
}
function getLastHistoryContent(){ return state.history.length?state.history[state.history.length-1].content:''; }
function computeDiffLines(a,b){
  if(!b) return [];
  const A = a.split(/\r?\n/), B = b.split(/\r?\n/);
  const changed=[];
  const max = Math.max(A.length,B.length);
  for(let i=0;i<max;i++){
    if((A[i]||'') !== (B[i]||'')) changed.push({line:i+1,old:B[i]||'',new:A[i]||''});
  }
  return changed;
}
function updateVCount(){ vcount.textContent = state.history.length; }
btnSaveVersion.addEventListener('click', ()=>{ pushHistory('user-save'); alert('Versión guardada.'); });
btnExportAll.addEventListener('click', ()=>{ downloadJSON(state.history, 'codeinsertor_history.json'); });

/* persist en localStorage simple */
function persistHistory(){
  try{
    localStorage.setItem('codeinsertor_history', JSON.stringify(state.history));
  }catch(e){}
}
function loadHistory(){
  try{
    const h = JSON.parse(localStorage.getItem('codeinsertor_history')||'[]');
    if(Array.isArray(h)) state.history = h.slice(-state.maxHistory);
  }catch(e){ state.history=[]; }
  updateVCount();
}
loadHistory();

/* ============================
   Clear cache
   ============================ */
btnClearCache.addEventListener('click', ()=>{
  if(confirm('Borrar historial local (IndexedDB/localStorage) y versiones guardadas?')) {
    state.history = []; persistHistory(); updateVCount(); alert('Cache limpiado');
  }
});

/* ============================
   Export / Save to disk
   - uses showSaveFilePicker if available
   ============================ */
btnSaveDisk.addEventListener('click', async ()=>{
  const content = originalEl.value;
  if(window.showSaveFilePicker){
    try{
      const handle = await showSaveFilePicker({suggestedName:'file.txt', types:[{description:'Text',accept:{'text/plain':['.txt','.js','.py','.html','.css']}}]});
      const stream = await handle.createWritable();
      await stream.write(content);
      await stream.close();
      alert('Guardado en disco OK');
    }catch(e){ console.error(e); alert('Operación cancelada o no soportada'); }
  }else{
    downloadText(content, 'file.txt');
  }
});

/* ============================
   Helper: download
   ============================ */
function downloadText(text, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
}
function downloadJSON(obj, filename){
  downloadText(JSON.stringify(obj, null, 2), filename);
}

/* ============================
   IA Integration (opcional)
   - No backend: puedes pegar tu API key (inseguro).
   - Recomendado: proveer proxyEndpoint que haga la llamada al API de OpenAI.
   ============================ */
btnAI.addEventListener('click', async ()=>{
  const proxy = proxyInput.value.trim();
  const key = apiKeyInput.value.trim();
  const insert = insertEl.value;
  const original = originalEl.value;
  if(!insert.trim()){ alert('La ventana 2 está vacía.'); return; }
  matchInfo.textContent = 'Consultando IA...';
  // build a prompt: ask the model to find best insertion/replacement location and explain
  const system = "Eres un asistente que dado un archivo original y un fragmento de código, INDICA la ubicación exacta (líneas) donde ese fragmento debería reemplazar o insertarse. Devuelve JSON con campos: action (replace|insert_above|insert_below|unknown), startLine, endLine, explanation.";
  const user = `Archivo original:\n-----\n${original}\n-----\nFragmento a insertar:\n-----\n${insert}\n-----\nResponde SOLO JSON.`;
  try{
    let responseText='';
    if(proxy){
      // proxy should forward request to OpenAI
      const r = await fetch(proxy, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system,user})});
      if(!r.ok) throw new Error('Proxy error '+r.status);
      const j = await r.json();
      responseText = j.text || JSON.stringify(j);
    }else if(key){
      // direct call (INSEGURO): use fetch to OpenAI
      const r = await fetch('https://api.openai.com/v1/chat/completions',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages:[{role:'system',content:system},{role:'user',content:user}],
          max_tokens:800
        })
      });
      const j = await r.json();
      responseText = j.choices?.[0]?.message?.content || JSON.stringify(j);
    }else{
      alert('Pegar tu API key o configurar un endpoint proxy.');
      matchInfo.textContent = 'IA no ejecutada.';
      return;
    }
    // intentar parsear JSON
    let parsed;
    try{ parsed = JSON.parse(responseText); }catch(e){
      // intentar extraer JSON de un texto
      const m = responseText.match(/\{[\s\S]*\}/);
      parsed = m ? JSON.parse(m[0]) : null;
    }
    if(!parsed){ matchInfo.textContent = 'IA respondió pero no devolvió JSON interpretable.'; return; }
    // usar parsed
    const action = parsed.action || 'unknown';
    const startLine = parsed.startLine || null;
    const endLine = parsed.endLine || null;
    const explanation = parsed.explanation || '';
    matchInfo.innerHTML = `<strong>IA sugiere:</strong> ${action} ${startLine && endLine ? `líneas ${startLine}-${endLine}`:''}<pre style="white-space:pre-wrap;margin-top:8px">${escapeHtml(explanation)}</pre>`;
    suggestedAction.textContent = action;
    scoreEl.textContent = 'IA';
    if(startLine && endLine){ state.chosen = {startLine, endLine, score:0.99, excerpt: original.split(/\r?\n/).slice(startLine-1, endLine).join('\n')}; highlightLines(startLine,endLine); }
  }catch(err){
    console.error(err);
    match
