<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CodeInsertor ‚Äî Prototipo Profesional Mejorado</title>
    <style>
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #57b3ff;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--panel);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .pane {
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            height: 70vh; /* Altura fija para scroll independiente */
        }

        .pane-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Evita que el header se encoja */
        }

        .pane-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .pane-content {
            flex: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto; /* Scroll independiente */
        }

        /* Controles flotantes para Ventana 3 */
        .floating-controls {
            position: sticky;
            top: 0;
            background: var(--panel);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .analysis-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(87, 179, 255, 0.1);
            border-radius: var(--radius);
            border-left: 4px solid var(--accent);
        }

        .match-percentage {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .analysis-stats {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        textarea {
            flex: 1;
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(87, 179, 255, 0.1);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #3d9ee8;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #0da271;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #e5940b;
        }

        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1;
            overflow-y: auto;
        }

        .suggestion-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }

        .suggestion-item.selected {
            background: rgba(87, 179, 255, 0.1);
            border-color: var(--accent);
        }

        .suggestion-score {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .suggestion-excerpt {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 120px;
            overflow: hidden;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .sticky-actions {
            position: sticky;
            bottom: 0;
            background: var(--panel);
            padding: 1rem 0;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        footer {
            background: var(--panel);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.idle {
            background: var(--warning);
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification .close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .modal {
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-content {
            padding: 1.5rem;
        }

        .code-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .code-block {
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .code-block-header {
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .code-block-content {
            padding: 1rem;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .diff-added {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .diff-removed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .filename-input {
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
        }

        .filename-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .history-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .history-entry {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .history-time {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .history-note {
            color: var(--text-secondary);
        }

        .placeholder-text {
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="header-content">
                <div class="logo">
                    <h1>CodeInsertor</h1>
                    <span class="version">v1.2</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Listo</span>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- Ventana 1: C√≥digo Original -->
            <section class="pane" id="pane-original">
                <div class="pane-header">
                    <h2>C√≥digo Original</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearOriginal()">Limpiar</button>
                        <button class="btn btn-secondary" onclick="loadExample('original')">Ejemplo</button>
                    </div>
                </div>
                <div class="pane-content">
                    <textarea id="originalEl" placeholder="Pega tu c√≥digo original aqu√≠..."></textarea>
                    <div class="file-info">
                        <input type="file" id="fileInputOriginal" accept=".js,.py,.html,.css,.txt,.cs,.java,.php,.rb,.go,.rs,.ts" 
                               onchange="handleFileUpload(event, 'original')" style="display: none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('fileInputOriginal').click()">
                            Cargar Archivo
                        </button>
                    </div>
                </div>
            </section>

            <!-- Ventana 2: Fragmento a Insertar -->
            <section class="pane" id="pane-insert">
                <div class="pane-header">
                    <h2>Fragmento a Insertar</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearInsert()">Limpiar</button>
                        <button class="btn btn-secondary" onclick="loadExample('insert')">Ejemplo</button>
                    </div>
                </div>
                <div class="pane-content">
                    <textarea id="insertEl" placeholder="Pega el fragmento que quieres insertar..."></textarea>
                    <button class="btn" id="analyzeBtn" onclick="runLocalAnalysis()">
                        Analizar Coincidencias
                    </button>
                </div>
            </section>

            <!-- Ventana 3: An√°lisis y Resultados -->
            <section class="pane" id="pane-analysis">
                <div class="pane-header">
                    <h2>An√°lisis y Resultados</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="runDiagnostics()">Pruebas</button>
                        <button class="btn btn-warning" onclick="showAIAnalysis()">An√°lisis IA</button>
                    </div>
                </div>
                <div class="pane-content">
                    <!-- Controles flotantes siempre visibles -->
                    <div class="floating-controls">
                        <div class="analysis-info">
                            <div class="match-percentage" id="matchPercentage">
                                Coincidencia: 0%
                            </div>
                            <div class="analysis-stats" id="analysisStats">
                                Sin an√°lisis
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="applyEdit('replace')" id="replaceBtn" disabled>Reemplazar</button>
                            <button class="btn" onclick="applyEdit('above')" id="aboveBtn" disabled>Insertar Arriba</button>
                            <button class="btn" onclick="applyEdit('below')" id="belowBtn" disabled>Insertar Debajo</button>
                        </div>
                    </div>

                    <!-- Contenido con scroll independiente -->
                    <div id="resultsContainer">
                        <p class="placeholder-text">Los resultados del an√°lisis aparecer√°n aqu√≠...</p>
                        <div class="suggestion-list" id="suggestionList" style="display: none;"></div>
                    </div>

                    <!-- Historial siempre visible en el fondo -->
                    <div class="history-section" id="historySection" style="display: none;">
                        <h3>Historial Reciente</h3>
                        <div id="historyList"></div>
                    </div>

                    <!-- Acciones sticky en la parte inferior -->
                    <div class="sticky-actions" id="stickyActions" style="display: none;">
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="clearAnalysis()">Limpiar An√°lisis</button>
                            <button class="btn" onclick="exportAnalysis()">Exportar Resultados</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-info">
                    <p>CodeInsertor v1.2 - An√°lisis de c√≥digo local y seguro</p>
                </div>
                <div class="footer-actions">
                    <button class="btn btn-secondary" onclick="showHelp()">Ayuda</button>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        const state = {
            language: 'auto',
            suggestions: [],
            chosen: null,
            history: [],
            undoStack: [],
            redoStack: [],
            maxHistory: 5,
            originalContent: '',
            modifiedContent: '',
            status: 'idle',
            currentMatchPercentage: 0
        };

        // Elementos DOM
        const originalEl = document.getElementById('originalEl');
        const insertEl = document.getElementById('insertEl');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const suggestionList = document.getElementById('suggestionList');
        const resultsContainer = document.getElementById('resultsContainer');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const matchPercentage = document.getElementById('matchPercentage');
        const analysisStats = document.getElementById('analysisStats');
        const replaceBtn = document.getElementById('replaceBtn');
        const aboveBtn = document.getElementById('aboveBtn');
        const belowBtn = document.getElementById('belowBtn');
        const stickyActions = document.getElementById('stickyActions');

        // Sistema de notificaciones
        class NotificationSystem {
            static show(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <span class="icon">${this.getIcon(type)}</span>
                    <span class="message">${message}</span>
                    <button class="close" onclick="this.parentElement.remove()">√ó</button>
                `;
                
                document.body.appendChild(notification);
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            static getIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || icons.info;
            }
        }

        // Sistema de historial robusto
        class RobustHistoryManager {
            static pushHistory(note = 'manual') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    note,
                    content: originalEl.value,
                    diffLines: this.computeDiff(state.originalContent, originalEl.value)
                };

                // Gesti√≥n de l√≠mite
                if (state.history.length >= state.maxHistory) {
                    state.history.shift();
                }

                state.history.push(entry);
                this.persist();
                this.updateDisplay();
            }

            static computeDiff(original, modified) {
                // Implementaci√≥n simplificada de diff
                const originalLines = original.split('\n');
                const modifiedLines = modified.split('\n');
                const diff = [];

                for (let i = 0; i < Math.max(originalLines.length, modifiedLines.length); i++) {
                    if (originalLines[i] !== modifiedLines[i]) {
                        diff.push({
                            line: i + 1,
                            original: originalLines[i] || '',
                            modified: modifiedLines[i] || ''
                        });
                    }
                }

                return diff;
            }

            static persist() {
                try {
                    if (!this.isLocalStorageAvailable()) {
                        throw new Error('localStorage no disponible');
                    }

                    const storageItem = {
                        data: state.history,
                        timestamp: Date.now(),
                        version: '1.2'
                    };

                    localStorage.setItem('codeinsertor_history', JSON.stringify(storageItem));
                    console.log('Historial persistido correctamente');
                } catch (error) {
                    console.warn('Error persistiendo historial:', error);
                    this.useFallbackStorage();
                }
            }

            static isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            static useFallbackStorage() {
                // Fallback a sessionStorage o variable en memoria
                try {
                    sessionStorage.setItem('codeinsertor_history_fallback', JSON.stringify(state.history));
                    console.log('Usando sessionStorage como fallback');
                } catch (error) {
                    console.log('Usando almacenamiento en memoria');
                    // En memoria ya est√° gestionado por el estado
                }
            }

            static updateDisplay() {
                if (state.history.length === 0) {
                    historySection.style.display = 'none';
                    return;
                }

                historySection.style.display = 'block';
                historyList.innerHTML = state.history
                    .slice(-3)
                    .reverse()
                    .map(entry => `
                        <div class="history-entry">
                            <div class="history-time">${new Date(entry.timestamp).toLocaleTimeString()}</div>
                            <div class="history-note">${entry.note}</div>
                        </div>
                    `).join('');
            }
        }

        // Analizador local mejorado
        class LocalAnalyzer {
            static analyzeLocal(originalText, insertText) {
                if (!insertText.trim()) {
                    throw new Error('El fragmento a insertar est√° vac√≠o');
                }

                const tokensOriginal = this.tokenize(originalText);
                const tokensInsert = this.tokenize(insertText);

                return this.slidingWindowAnalysis(tokensOriginal, tokensInsert, originalText);
            }

            static tokenize(text) {
                return text.toLowerCase()
                    .split(/[^a-z0-9_]+/)
                    .filter(Boolean);
            }

            static slidingWindowAnalysis(tokensOriginal, tokensInsert, originalText) {
                const results = [];
                const insertSet = new Set(tokensInsert);
                const windowSize = Math.max(tokensInsert.length, 10);
                
                for (let i = 0; i <= tokensOriginal.length - windowSize; i++) {
                    const windowTokens = tokensOriginal.slice(i, i + windowSize);
                    const windowSet = new Set(windowTokens);
                    
                    const similarity = this.jaccardSimilarity(insertSet, windowSet);
                    
                    if (similarity > 0.3) { // Umbral de similitud
                        const startLine = this.findLineNumber(originalText, i);
                        const endLine = this.findLineNumber(originalText, i + windowSize);
                        
                        results.push({
                            startLine,
                            endLine,
                            score: similarity,
                            excerpt: this.getExcerpt(originalText, startLine, endLine)
                        });
                    }
                }

                return results.sort((a, b) => b.score - a.score).slice(0, 5);
            }

            static jaccardSimilarity(setA, setB) {
                const intersection = new Set([...setA].filter(x => setB.has(x)));
                const union = new Set([...setA, ...setB]);
                return intersection.size / union.size;
            }

            static findLineNumber(text, tokenIndex) {
                const lines = text.split('\n');
                let currentLength = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const lineTokens = this.tokenize(lines[i]);
                    if (tokenIndex < lineTokens.length) {
                        return i + 1;
                    }
                    tokenIndex -= lineTokens.length;
                }
                
                return lines.length;
            }

            static getExcerpt(text, startLine, endLine) {
                const lines = text.split('\n');
                return lines.slice(Math.max(0, startLine - 2), endLine + 1).join('\n');
            }
        }

        // Funciones principales
        function runLocalAnalysis() {
            setStatus('analyzing', 'Analizando c√≥digo...');

            try {
                const results = LocalAnalyzer.analyzeLocal(originalEl.value, insertEl.value);
                state.suggestions = results;
                state.originalContent = originalEl.value;

                displayResults(results);
                updateAnalysisInfo(results);
                setStatus('success', 'An√°lisis completado');

                NotificationSystem.show(`Encontradas ${results.length} coincidencias`, 'success');
            } catch (error) {
                setStatus('error', 'Error en an√°lisis');
                NotificationSystem.show(`Error: ${error.message}`, 'error');
                console.error('Error en an√°lisis:', error);
            }
        }

        function displayResults(results) {
            const placeholder = resultsContainer.querySelector('.placeholder-text');
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            if (results.length === 0) {
                suggestionList.innerHTML = '<p class="placeholder-text">No se encontraron coincidencias significativas</p>';
                suggestionList.style.display = 'block';
                stickyActions.style.display = 'none';
                return;
            }

            suggestionList.innerHTML = results.map((result, index) => `
                <div class="suggestion-item ${index === 0 ? 'selected' : ''}" 
                     onclick="selectSuggestion(${index})">
                    <span class="suggestion-score">${Math.round(result.score * 100)}% coincidencia</span>
                    <div class="suggestion-excerpt">L√≠neas ${result.startLine}-${result.endLine}:\n${result.excerpt}</div>
                </div>
            `).join('');

            suggestionList.style.display = 'block';
            stickyActions.style.display = 'block';
            state.chosen = results[0];
            
            // Habilitar botones de acci√≥n
            replaceBtn.disabled = false;
            aboveBtn.disabled = false;
            belowBtn.disabled = false;
        }

        function updateAnalysisInfo(results) {
            if (results.length === 0) {
                matchPercentage.textContent = 'Coincidencia: 0%';
                analysisStats.textContent = 'Sin coincidencias';
                state.currentMatchPercentage = 0;
                return;
            }

            const bestMatch = results[0];
            const percentage = Math.round(bestMatch.score * 100);
            state.currentMatchPercentage = percentage;
            
            matchPercentage.textContent = `Coincidencia: ${percentage}%`;
            analysisStats.textContent = `${results.length} sugerencias ¬∑ L√≠neas ${bestMatch.startLine}-${bestMatch.endLine}`;
        }

        function selectSuggestion(index) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Seleccionar nuevo item
            document.querySelectorAll('.suggestion-item')[index].classList.add('selected');
            state.chosen = state.suggestions[index];
            
            // Actualizar informaci√≥n
            updateAnalysisInfo(state.suggestions);
        }

        function applyEdit(mode) {
            if (!state.chosen) {
                NotificationSystem.show('Por favor selecciona una sugerencia primero', 'warning');
                return;
            }

            const modifiedCode = applyCodeChanges(mode);
            showExportDialog(modifiedCode);
        }

        function applyCodeChanges(mode) {
            const lines = originalEl.value.split('\n');
            const insertContent = insertEl.value;
            const startIndex = state.chosen.startLine - 1;
            
            let modifiedLines;

            switch (mode) {
                case 'replace':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(state.chosen.endLine)
                    ];
                    break;
                case 'above':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(startIndex)
                    ];
                    break;
                case 'below':
                    modifiedLines = [
                        ...lines.slice(0, state.chosen.endLine),
                        insertContent,
                        ...lines.slice(state.chosen.endLine)
                    ];
                    break;
                default:
                    modifiedLines = lines;
            }

            return modifiedLines.join('\n');
        }

        function clearAnalysis() {
            state.suggestions = [];
            state.chosen = null;
            suggestionList.style.display = 'none';
            stickyActions.style.display = 'none';
            replaceBtn.disabled = true;
            aboveBtn.disabled = true;
            belowBtn.disabled = true;
            
            const placeholder = resultsContainer.querySelector('.placeholder-text');
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            
            matchPercentage.textContent = 'Coincidencia: 0%';
            analysisStats.textContent = 'Sin an√°lisis';
            
            NotificationSystem.show('An√°lisis limpiado', 'info');
        }

        function exportAnalysis() {
            if (state.suggestions.length === 0) {
                NotificationSystem.show('No hay resultados para exportar', 'warning');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                originalLength: originalEl.value.length,
                insertLength: insertEl.value.length,
                suggestions: state.suggestions,
                bestMatch: state.chosen
            };

            const content = `AN√ÅLISIS CODEINSERTOR\n====================\n\n` +
                           `Fecha: ${new Date().toLocaleString()}\n` +
                           `Coincidencia m√°xima: ${state.currentMatchPercentage}%\n` +
                           `Sugerencias encontradas: ${state.suggestions.length}\n\n` +
                           `MEJOR COINCIDENCIA:\n${'-'.repeat(50)}\n` +
                           `L√≠neas: ${state.chosen.startLine}-${state.chosen.endLine}\n` +
                           `Score: ${Math.round(state.chosen.score * 100)}%\n\n` +
                           `Fragmento:\n${state.chosen.excerpt}\n\n` +
                           `TODAS LAS SUGERENCIAS:\n${'-'.repeat(50)}\n` +
                           state.suggestions.map((s, i) => 
                               `${i + 1}. L√≠neas ${s.startLine}-${s.endLine} (${Math.round(s.score * 100)}%):\n${s.excerpt}\n`
                           ).join('\n');

            downloadText(content, `analisis-codeinsertor-${new Date().toISOString().slice(0, 10)}.txt`);
            NotificationSystem.show('Resultados exportados', 'success');
        }

        // ... (resto de las funciones se mantienen igual)

        function showAIAnalysis() {
            NotificationSystem.show(
                `üîÆ An√°lisis IA - Pr√≥ximamente\n\n` +
                `Caracter√≠sticas planeadas:\n` +
                `‚Ä¢ Resumen inteligente del c√≥digo\n` +
                `‚Ä¢ Detecci√≥n de patrones y antipatrones\n` +
                `‚Ä¢ Sugerencias de optimizaci√≥n\n` +
                `‚Ä¢ Integraci√≥n con APIs: OpenAI, DeepSeek, Gemini\n\n` +
                `¬øNecesitas ayuda para configurar API keys?`,
                'info'
            );
        }

        // Funciones de utilidad
        function setStatus(status, message) {
            state.status = status;
            statusText.textContent = message;
            statusDot.className = 'status-dot ' + status;
        }

        function clearOriginal() {
            originalEl.value = '';
            NotificationSystem.show('Ventana original limpiada', 'info');
        }

        function clearInsert() {
            insertEl.value = '';
            NotificationSystem.show('Ventana de inserci√≥n limpiada', 'info');
        }

        function loadExample(type) {
            const examples = {
                original: `function calcularSuma(a, b) {
    // Esta funci√≥n calcula la suma de dos n√∫meros
    return a + b;
}

function procesarDatos(datos) {
    let resultado = [];
    for (let i = 0; i < datos.length; i++) {
        if (datos[i] > 10) {
            resultado.push(datos[i] * 2);
        }
    }
    return resultado;
}`,
                insert: `// Nueva funci√≥n mejorada con validaci√≥n
function calcularSumaSegura(a, b) {
    if (typeof a !== 'number' || typeof b !== 'number') {
        throw new Error('Los par√°metros deben ser n√∫meros');
    }
    return a + b;
}`
            };

            if (type === 'original') {
                originalEl.value = examples.original;
            } else {
                insertEl.value = examples.insert;
            }

            NotificationSystem.show('Ejemplo cargado', 'success');
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'original') {
                    originalEl.value = e.target.result;
                    state.originalContent = e.target.result;
                } else {
                    insertEl.value = e.target.result;
                }
                NotificationSystem.show(`Archivo ${file.name} cargado`, 'success');
            };
            reader.readAsText(file);
        }

        function runDiagnostics() {
            setStatus('testing', 'Ejecutando pruebas...');
            setTimeout(() => {
                // Sistema de pruebas simplificado
                try {
                    const originalBackup = originalEl.value;
                    const insertBackup = insertEl.value;
                    
                    originalEl.value = '// Test temporal';
                    insertEl.value = '// Test temporal';
                    
                    if (originalEl.value.includes('Test') && insertEl.value.includes('Test')) {
                        NotificationSystem.show('‚úÖ Pruebas pasadas correctamente', 'success');
                    } else {
                        throw new Error('Las pruebas fallaron');
                    }
                    
                    originalEl.value = originalBackup;
                    insertEl.value = insertBackup;
                } catch (error) {
                    NotificationSystem.show('‚ùå Algunas pruebas fallaron', 'error');
                }
                setStatus('success', 'Pruebas completadas');
            }, 1000);
        }

        function showHelp() {
            const helpContent = `
CODEINSERTOR v1.2 - GU√çA COMPLETA
=================================

üéØ C√ìMO USAR:
1. Carga o pega tu c√≥digo en "C√≥digo Original"
2. Pega el fragmento a insertar en "Fragmento a Insertar"  
3. Haz clic en "Analizar Coincidencias"
4. Revisa los resultados ordenados por porcentaje de coincidencia
5. Selecciona la mejor ubicaci√≥n y elige una acci√≥n
6. Confirma y descarga el archivo modificado

üîß CARACTER√çSTICAS:
‚Ä¢ An√°lisis 100% local - tu c√≥digo nunca sale de tu navegador
‚Ä¢ Scroll independiente en todas las ventanas
‚Ä¢ Controles siempre visibles en Ventana 3
‚Ä¢ Historial de operaciones
‚Ä¢ Sistema de pruebas integrado

ü§ñ INTEGRACI√ìN CON IA (Pr√≥ximamente):
Para usar APIs de IA necesitar√°s:

1. OPENAI (ChatGPT):
   ‚Ä¢ Ve a platform.openai.com
   ‚Ä¢ Crea una cuenta y genera una API Key
   ‚Ä¢ Costo: ~$0.002-0.02 por solicitud

2. DEEPSEEK:
   ‚Ä¢ Reg√≠strate en platform.deepseek.com
   ‚Ä¢ Obt√©n tu API Key gratuita
   ‚Ä¢ L√≠mites generosos gratuitos

3. GEMINI (Google):
   ‚Ä¢ Google AI Studio
   ‚Ä¢ API Key gratuita con cuotas

üìä VENTANA 3 MEJORADA:
‚Ä¢ Porcentaje de coincidencia siempre visible
‚Ä¢ Controles de acci√≥n fijos en la parte superior
‚Ä¢ Historial en la parte inferior
‚Ä¢ Scroll independiente para mejor navegaci√≥n

üí° CONSEJOS:
‚Ä¢ Usa ejemplos para probar r√°pidamente
‚Ä¢ El an√°lisis funciona mejor con c√≥digo similar
‚Ä¢ Exporta resultados para documentaci√≥n
‚Ä¢ Las pruebas verifican que todo funcione correctamente

¬øNecesitas m√°s ayuda? ¬°Los an√°lisis con IA llegar√°n pronto!
            `;
            
            alert(helpContent);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            setStatus('success', 'Listo para usar');
            RobustHistoryManager.updateDisplay();
            
            // Cargar historial si existe
            try {
                const stored = localStorage.getItem('codeinsertor_history');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.data && Array.isArray(data.data)) {
                        state.history = data.data.slice(-state.maxHistory);
                        RobustHistoryManager.updateDisplay();
                    }
                }
            } catch (error) {
                console.log('No se pudo cargar historial previo:', error);
            }

            NotificationSystem.show('CodeInsertor v1.2 cargado - Ventana 3 mejorada!', 'success');
        });

        // ... (resto de funciones de exportaci√≥n y modales se mantienen igual)
    </script>
</body>
</html>
