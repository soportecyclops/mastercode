<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CodeInsertor — Prototipo Profesional Mejorado</title>
    <style>
        :root {
            --bg: #0f1724;
            --panel: #0b1220;
            --accent: #57b3ff;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--panel);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .pane {
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
        }

        .pane-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pane-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .pane-content {
            flex: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        textarea {
            flex: 1;
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            color: var(--text);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(87, 179, 255, 0.1);
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #3d9ee8;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #0da271;
        }

        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .suggestion-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }

        .suggestion-item.selected {
            background: rgba(87, 179, 255, 0.1);
            border-color: var(--accent);
        }

        .suggestion-score {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .suggestion-excerpt {
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        footer {
            background: var(--panel);
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.idle {
            background: var(--warning);
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .notification .close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .modal {
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-content {
            padding: 1.5rem;
        }

        .code-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .code-block {
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .code-block-header {
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .code-block-content {
            padding: 1rem;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .diff-added {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .diff-removed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .filename-input {
            background: #0a0f1a;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            color: var(--text);
            font-family: inherit;
        }

        .filename-input:focus {
            outline: none;
            border-color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="header-content">
                <div class="logo">
                    <h1>CodeInsertor</h1>
                    <span class="version">v1.1</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Listo</span>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- Ventana 1: Código Original -->
            <section class="pane" id="pane-original">
                <div class="pane-header">
                    <h2>Código Original</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearOriginal()">Limpiar</button>
                        <button class="btn btn-secondary" onclick="loadExample('original')">Ejemplo</button>
                    </div>
                </div>
                <div class="pane-content">
                    <textarea id="originalEl" placeholder="Pega tu código original aquí..."></textarea>
                    <div class="file-info">
                        <input type="file" id="fileInput" accept=".js,.py,.html,.css,.txt,.cs,.java,.php,.rb,.go,.rs,.ts" 
                               onchange="handleFileUpload(event, 'original')" style="display: none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                            Cargar Archivo
                        </button>
                    </div>
                </div>
            </section>

            <!-- Ventana 2: Fragmento a Insertar -->
            <section class="pane" id="pane-insert">
                <div class="pane-header">
                    <h2>Fragmento a Insertar</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearInsert()">Limpiar</button>
                        <button class="btn btn-secondary" onclick="loadExample('insert')">Ejemplo</button>
                    </div>
                </div>
                <div class="pane-content">
                    <textarea id="insertEl" placeholder="Pega el fragmento que quieres insertar..."></textarea>
                    <button class="btn" id="analyzeBtn" onclick="runLocalAnalysis()">
                        Analizar Coincidencias
                    </button>
                </div>
            </section>

            <!-- Ventana 3: Análisis y Resultados -->
            <section class="pane" id="pane-analysis">
                <div class="pane-header">
                    <h2>Análisis y Resultados</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="runDiagnostics()">Ejecutar Pruebas</button>
                    </div>
                </div>
                <div class="pane-content">
                    <div id="resultsContainer">
                        <p class="placeholder-text">Los resultados del análisis aparecerán aquí...</p>
                        <div class="suggestion-list" id="suggestionList" style="display: none;"></div>
                    </div>
                    
                    <div class="action-buttons" id="actionButtons" style="display: none;">
                        <button class="btn btn-success" onclick="applyEdit('replace')">Reemplazar</button>
                        <button class="btn" onclick="applyEdit('above')">Insertar Arriba</button>
                        <button class="btn" onclick="applyEdit('below')">Insertar Debajo</button>
                    </div>

                    <div class="history-section" style="display: none;" id="historySection">
                        <h3>Historial Reciente</h3>
                        <div id="historyList"></div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-info">
                    <p>CodeInsertor v1.1 - Análisis de código local y seguro</p>
                </div>
                <div class="footer-actions">
                    <button class="btn btn-secondary" onclick="showHelp()">Ayuda</button>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Estado de la aplicación
        const state = {
            language: 'auto',
            suggestions: [],
            chosen: null,
            history: [],
            undoStack: [],
            redoStack: [],
            maxHistory: 5,
            originalContent: '',
            modifiedContent: '',
            status: 'idle'
        };

        // Elementos DOM
        const originalEl = document.getElementById('originalEl');
        const insertEl = document.getElementById('insertEl');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const suggestionList = document.getElementById('suggestionList');
        const actionButtons = document.getElementById('actionButtons');
        const resultsContainer = document.getElementById('resultsContainer');
        const historySection = document.getElementById('historySection');
        const historyList = document.getElementById('historyList');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Sistema de notificaciones
        class NotificationSystem {
            static show(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <span class="icon">${this.getIcon(type)}</span>
                    <span class="message">${message}</span>
                    <button class="close" onclick="this.parentElement.remove()">×</button>
                `;
                
                document.body.appendChild(notification);
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            static getIcon(type) {
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };
                return icons[type] || icons.info;
            }
        }

        // Sistema de historial robusto
        class RobustHistoryManager {
            static pushHistory(note = 'manual') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    note,
                    content: originalEl.value,
                    diffLines: this.computeDiff(state.originalContent, originalEl.value)
                };

                // Gestión de límite
                if (state.history.length >= state.maxHistory) {
                    state.history.shift();
                }

                state.history.push(entry);
                this.persist();
                this.updateDisplay();
            }

            static computeDiff(original, modified) {
                // Implementación simplificada de diff
                const originalLines = original.split('\n');
                const modifiedLines = modified.split('\n');
                const diff = [];

                for (let i = 0; i < Math.max(originalLines.length, modifiedLines.length); i++) {
                    if (originalLines[i] !== modifiedLines[i]) {
                        diff.push({
                            line: i + 1,
                            original: originalLines[i] || '',
                            modified: modifiedLines[i] || ''
                        });
                    }
                }

                return diff;
            }

            static persist() {
                try {
                    if (!this.isLocalStorageAvailable()) {
                        throw new Error('localStorage no disponible');
                    }

                    const storageItem = {
                        data: state.history,
                        timestamp: Date.now(),
                        version: '1.1'
                    };

                    localStorage.setItem('codeinsertor_history', JSON.stringify(storageItem));
                    console.log('Historial persistido correctamente');
                } catch (error) {
                    console.warn('Error persistiendo historial:', error);
                    this.useFallbackStorage();
                }
            }

            static isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            static useFallbackStorage() {
                // Fallback a sessionStorage o variable en memoria
                try {
                    sessionStorage.setItem('codeinsertor_history_fallback', JSON.stringify(state.history));
                    console.log('Usando sessionStorage como fallback');
                } catch (error) {
                    console.log('Usando almacenamiento en memoria');
                    // En memoria ya está gestionado por el estado
                }
            }

            static updateDisplay() {
                if (state.history.length === 0) {
                    historySection.style.display = 'none';
                    return;
                }

                historySection.style.display = 'block';
                historyList.innerHTML = state.history
                    .slice(-3)
                    .reverse()
                    .map(entry => `
                        <div class="history-entry">
                            <div class="history-time">${new Date(entry.timestamp).toLocaleTimeString()}</div>
                            <div class="history-note">${entry.note}</div>
                        </div>
                    `).join('');
            }
        }

        // Analizador local mejorado
        class LocalAnalyzer {
            static analyzeLocal(originalText, insertText) {
                if (!insertText.trim()) {
                    throw new Error('El fragmento a insertar está vacío');
                }

                const tokensOriginal = this.tokenize(originalText);
                const tokensInsert = this.tokenize(insertText);

                return this.slidingWindowAnalysis(tokensOriginal, tokensInsert, originalText);
            }

            static tokenize(text) {
                return text.toLowerCase()
                    .split(/[^a-z0-9_]+/)
                    .filter(Boolean);
            }

            static slidingWindowAnalysis(tokensOriginal, tokensInsert, originalText) {
                const results = [];
                const insertSet = new Set(tokensInsert);
                const windowSize = Math.max(tokensInsert.length, 10);
                
                for (let i = 0; i <= tokensOriginal.length - windowSize; i++) {
                    const windowTokens = tokensOriginal.slice(i, i + windowSize);
                    const windowSet = new Set(windowTokens);
                    
                    const similarity = this.jaccardSimilarity(insertSet, windowSet);
                    
                    if (similarity > 0.3) { // Umbral de similitud
                        const startLine = this.findLineNumber(originalText, i);
                        const endLine = this.findLineNumber(originalText, i + windowSize);
                        
                        results.push({
                            startLine,
                            endLine,
                            score: similarity,
                            excerpt: this.getExcerpt(originalText, startLine, endLine)
                        });
                    }
                }

                return results.sort((a, b) => b.score - a.score).slice(0, 5);
            }

            static jaccardSimilarity(setA, setB) {
                const intersection = new Set([...setA].filter(x => setB.has(x)));
                const union = new Set([...setA, ...setB]);
                return intersection.size / union.size;
            }

            static findLineNumber(text, tokenIndex) {
                const lines = text.split('\n');
                let currentLength = 0;
                
                for (let i = 0; i < lines.length; i++) {
                    const lineTokens = this.tokenize(lines[i]);
                    if (tokenIndex < lineTokens.length) {
                        return i + 1;
                    }
                    tokenIndex -= lineTokens.length;
                }
                
                return lines.length;
            }

            static getExcerpt(text, startLine, endLine) {
                const lines = text.split('\n');
                return lines.slice(Math.max(0, startLine - 2), endLine + 1).join('\n');
            }
        }

        // Sistema de diagnóstico mejorado (NO BORRA CONTENIDO)
        class DiagnosticSystem {
            static runTests() {
                const tests = [
                    this.testTextareas(),
                    this.testAnalysis(),
                    this.testHistory(),
                    this.testExport()
                ];

                let allPassed = true;
                const results = [];

                tests.forEach(test => {
                    try {
                        const result = test();
                        results.push(`✅ ${result}`);
                    } catch (error) {
                        allPassed = false;
                        results.push(`❌ ${error.message}`);
                    }
                });

                const message = allPassed 
                    ? 'Todas las pruebas pasaron correctamente'
                    : 'Algunas pruebas fallaron';

                NotificationSystem.show(`${message}\n${results.join('\n')}`, 
                    allPassed ? 'success' : 'warning');
                
                return allPassed;
            }

            static testTextareas() {
                // BACKUP del contenido original
                const originalBackup = originalEl.value;
                const insertBackup = insertEl.value;

                try {
                    // Test temporal sin afectar contenido real
                    originalEl.value = '// Test de funcionalidad - código temporal';
                    insertEl.value = '// Test de funcionalidad - fragmento temporal';
                    
                    // Validar que los textareas funcionan
                    if (originalEl.value !== '// Test de funcionalidad - código temporal' ||
                        insertEl.value !== '// Test de funcionalidad - fragmento temporal') {
                        throw new Error('Los textareas no están funcionando correctamente');
                    }

                    // RESTAURAR CONTENIDO ORIGINAL
                    originalEl.value = originalBackup;
                    insertEl.value = insertBackup;

                    return 'Textareas funcionando correctamente';
                } catch (error) {
                    // Restaurar incluso en caso de error
                    originalEl.value = originalBackup;
                    insertEl.value = insertBackup;
                    throw error;
                }
            }

            static testAnalysis() {
                const testOriginal = 'function hello() {\n  return "world";\n}';
                const testInsert = 'return "world"';

                try {
                    const results = LocalAnalyzer.analyzeLocal(testOriginal, testInsert);
                    if (!Array.isArray(results)) {
                        throw new Error('El análisis no devolvió un array');
                    }
                    return 'Sistema de análisis funcionando';
                } catch (error) {
                    throw new Error(`Análisis falló: ${error.message}`);
                }
            }

            static testHistory() {
                try {
                    RobustHistoryManager.pushHistory('test');
                    if (state.history.length === 0) {
                        throw new Error('El historial no se está guardando');
                    }
                    return 'Sistema de historial funcionando';
                } catch (error) {
                    throw new Error(`Historial falló: ${error.message}`);
                }
            }

            static testExport() {
                const testContent = 'test content';
                const filename = generateSmartFilename('test.js');
                
                if (!filename.includes('test') || !filename.includes('.js')) {
                    throw new Error('La generación de nombres de archivo falló');
                }
                
                return 'Sistema de exportación funcionando';
            }
        }

        // Funciones principales
        function runLocalAnalysis() {
            setStatus('analyzing', 'Analizando código...');

            try {
                const results = LocalAnalyzer.analyzeLocal(originalEl.value, insertEl.value);
                state.suggestions = results;
                state.originalContent = originalEl.value;

                displayResults(results);
                setStatus('success', 'Análisis completado');

                NotificationSystem.show(`Encontradas ${results.length} coincidencias`, 'success');
            } catch (error) {
                setStatus('error', 'Error en análisis');
                NotificationSystem.show(`Error: ${error.message}`, 'error');
                console.error('Error en análisis:', error);
            }
        }

        function displayResults(results) {
            const placeholder = resultsContainer.querySelector('.placeholder-text');
            if (placeholder) {
                placeholder.style.display = 'none';
            }

            if (results.length === 0) {
                suggestionList.innerHTML = '<p>No se encontraron coincidencias significativas</p>';
                suggestionList.style.display = 'block';
                actionButtons.style.display = 'none';
                return;
            }

            suggestionList.innerHTML = results.map((result, index) => `
                <div class="suggestion-item ${index === 0 ? 'selected' : ''}" 
                     onclick="selectSuggestion(${index})">
                    <span class="suggestion-score">${Math.round(result.score * 100)}% coincidencia</span>
                    <div class="suggestion-excerpt">Líneas ${result.startLine}-${result.endLine}:\n${result.excerpt}</div>
                </div>
            `).join('');

            suggestionList.style.display = 'block';
            actionButtons.style.display = 'flex';
            state.chosen = results[0];
        }

        function selectSuggestion(index) {
            // Remover selección anterior
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Seleccionar nuevo item
            document.querySelectorAll('.suggestion-item')[index].classList.add('selected');
            state.chosen = state.suggestions[index];
        }

        function applyEdit(mode) {
            if (!state.chosen) {
                NotificationSystem.show('Por favor selecciona una sugerencia primero', 'warning');
                return;
            }

            const modifiedCode = applyCodeChanges(mode);
            showExportDialog(modifiedCode);
        }

        function applyCodeChanges(mode) {
            const lines = originalEl.value.split('\n');
            const insertContent = insertEl.value;
            const startIndex = state.chosen.startLine - 1;
            
            let modifiedLines;

            switch (mode) {
                case 'replace':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(state.chosen.endLine)
                    ];
                    break;
                case 'above':
                    modifiedLines = [
                        ...lines.slice(0, startIndex),
                        insertContent,
                        ...lines.slice(startIndex)
                    ];
                    break;
                case 'below':
                    modifiedLines = [
                        ...lines.slice(0, state.chosen.endLine),
                        insertContent,
                        ...lines.slice(state.chosen.endLine)
                    ];
                    break;
                default:
                    modifiedLines = lines;
            }

            return modifiedLines.join('\n');
        }

        function showExportDialog(modifiedCode) {
            state.modifiedContent = modifiedCode;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Confirmar Cambios</h3>
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">×</button>
                    </div>
                    <div class="modal-content">
                        <p>Revisa los cambios antes de descargar:</p>
                        
                        <div class="code-comparison">
                            <div class="code-block">
                                <div class="code-block-header">Original</div>
                                <div class="code-block-content">${highlightChanges(state.originalContent, 'original')}</div>
                            </div>
                            <div class="code-block">
                                <div class="code-block-header">Modificado</div>
                                <div class="code-block-content">${highlightChanges(modifiedCode, 'modified')}</div>
                            </div>
                        </div>

                        <div class="export-options">
                            <label>
                                Nombre de archivo:
                                <input type="text" class="filename-input" id="exportFilename" 
                                       value="${generateSmartFilename()}" onchange="validateFilename(this)">
                            </label>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="confirmExport()">Descargar</button>
                                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function highlightChanges(content, type) {
            // Implementación simplificada de resaltado
            return content
                .split('\n')
                .map(line => {
                    if (type === 'modified' && !state.originalContent.includes(line)) {
                        return `<span class="diff-added">${line}</span>`;
                    }
                    return line;
                })
                .join('\n');
        }

        function generateSmartFilename(originalName = 'codigo') {
            const baseName = originalName.replace(/\.[^/.]+$/, "");
            const extension = originalName.includes('.') 
                ? originalName.split('.').pop() 
                : 'txt';
            
            const timestamp = new Date().toISOString()
                .replace(/[:.]/g, '-')
                .slice(0, -5);
            
            return `${baseName}-modificado-${timestamp}.${extension}`;
        }

        function validateFilename(input) {
            // Validación básica de nombre de archivo
            const invalidChars = /[<>:"/\\|?*]/g;
            if (invalidChars.test(input.value)) {
                input.style.borderColor = 'var(--error)';
                NotificationSystem.show('El nombre de archivo contiene caracteres inválidos', 'error');
            } else {
                input.style.borderColor = 'var(--border)';
            }
        }

        function confirmExport() {
            const filenameInput = document.getElementById('exportFilename');
            const filename = filenameInput.value || generateSmartFilename();
            
            downloadText(state.modifiedContent, filename);
            RobustHistoryManager.pushHistory('exportación');
            
            // Cerrar modal
            document.querySelector('.modal-overlay').remove();
            
            NotificationSystem.show(`Archivo ${filename} descargado correctamente`, 'success');
        }

        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funciones de utilidad
        function setStatus(status, message) {
            state.status = status;
            statusText.textContent = message;
            statusDot.className = 'status-dot ' + status;
        }

        function clearOriginal() {
            originalEl.value = '';
            NotificationSystem.show('Ventana original limpiada', 'info');
        }

        function clearInsert() {
            insertEl.value = '';
            NotificationSystem.show('Ventana de inserción limpiada', 'info');
        }

        function loadExample(type) {
            const examples = {
                original: `function calcularSuma(a, b) {
    // Esta función calcula la suma de dos números
    return a + b;
}

function procesarDatos(datos) {
    let resultado = [];
    for (let i = 0; i < datos.length; i++) {
        if (datos[i] > 10) {
            resultado.push(datos[i] * 2);
        }
    }
    return resultado;
}`,
                insert: `// Nueva función mejorada con validación
function calcularSumaSegura(a, b) {
    if (typeof a !== 'number' || typeof b !== 'number') {
        throw new Error('Los parámetros deben ser números');
    }
    return a + b;
}`
            };

            if (type === 'original') {
                originalEl.value = examples.original;
            } else {
                insertEl.value = examples.insert;
            }

            NotificationSystem.show('Ejemplo cargado', 'success');
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'original') {
                    originalEl.value = e.target.result;
                    state.originalContent = e.target.result;
                } else {
                    insertEl.value = e.target.result;
                }
                NotificationSystem.show(`Archivo ${file.name} cargado`, 'success');
            };
            reader.readAsText(file);
        }

        function runDiagnostics() {
            setStatus('testing', 'Ejecutando pruebas...');
            setTimeout(() => {
                DiagnosticSystem.runTests();
                setStatus('success', 'Pruebas completadas');
            }, 1000);
        }

        function showHelp() {
            NotificationSystem.show(
                `CodeInsertor v1.1 - Cómo usar:
1. Pega tu código en la ventana izquierda
2. Pega el fragmento a insertar en la ventana central
3. Haz clic en "Analizar Coincidencias"
4. Selecciona la mejor coincidencia
5. Elige la acción (Reemplazar/Insertar Arriba/Insertar Debajo)
6. Revisa y confirma los cambios
7. Descarga el archivo modificado`,
                'info'
            );
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            setStatus('success', 'Listo para usar');
            RobustHistoryManager.updateDisplay();
            
            // Cargar historial si existe
            try {
                const stored = localStorage.getItem('codeinsertor_history');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.data && Array.isArray(data.data)) {
                        state.history = data.data.slice(-state.maxHistory);
                        RobustHistoryManager.updateDisplay();
                    }
                }
            } catch (error) {
                console.log('No se pudo cargar historial previo:', error);
            }

            NotificationSystem.show('CodeInsertor v1.1 cargado correctamente', 'success');
        });
    </script>
</body>
</html>
